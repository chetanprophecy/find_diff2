#!/bin/bash

TODAY=`date +"%Y%m%d"`
YEAR_MONTH_DB2=`date +"1%y%m"`
YESTERDAY=`date -d "-1 day" +"%Y%m%d"`
DATE_TWO_DAYS_BACK=`date -d "-2 day" +"%Y%m%d"`

##Count Matching Files
IDW_COUNT_FILE=/tmp/IDW_count_match_rcex1p_to_f_claim_transaction_${TODAY}_$$.txt
DB2_COUNT_FILE=/tmp/DB2_count_match_rcex1p_to_f_claim_transaction_${TODAY}_$$.txt
COUNT_HTML_CODE=/tmp/IDW_DB2_count_match_rcex1p_to_f_claim_transaction_${TODAY}_$$.txt
echo "IDW Count File : $IDW_COUNT_FILE"
echo "DB2 Count File : $DB2_COUNT_FILE"

##Metric Matching Files
IDW_METRIC_FILE=/tmp/IDW_metric_match_rcex1p_to_f_claim_transaction_${TODAY}_$$.txt
DB2_METRIC_FILE=/tmp/DB2_metric_match_rcex1p_to_f_claim_transaction_${TODAY}_$$.txt
METRIC_HTML_CODE=/tmp/IDW_DB2_metric_match_rcex1p_to_f_claim_transaction_${TODAY}_$$.txt
echo "IDW Metric File : $IDW_METRIC_FILE"
echo "DB2 METRIC File : $DB2_METRIC_FILE"


IDW_RUN_IDS=`m_db unload /etl/apps/prod/rxclaim/sand/orca/db_rxclaim/db/netezza.rxclaim.main.dbc -select "SELECT RUN_ID FROM ORX_IDW_DM_PRD.ADMIN.F_CLAIM_TRANSACTION WHERE RUN_ID LIKE ('"$TODAY"%') GROUP BY 1 ORDER BY 1;" -column_delimiter "|" | tr -d "|" | tr '\n' ',' | sed 's/,/ , /g' | sed 's/,[ 	]*$//g'`
##################################################################################################################################################
##Get IDW destination counts
m_db unload /etl/apps/prod/rxclaim/sand/orca/db_rxclaim/db/netezza.rxclaim.main.dbc  -select "SELECT SRC_ENV_SK,COUNT(*) FROM ORX_IDW_DM_PRD.ADMIN.F_CLAIM_TRANSACTION WHERE RUN_ID IN ( $IDW_RUN_IDS )  group by 1;" -column_delimiter "|" >>$IDW_COUNT_FILE
##################################################################################################################################################
##Get DB2 BK1 and BK2 source counts
m_db unload /etl/apps/prod/rxclaim/sand/orca/db_orxclaim/db/odbc.db_orxclaim.dbc -select "SELECT 480 AS SRC_ENV_ID,COUNT(*) FROM DWXTRACT.RCEX1P
WHERE carrierid IS NOT NULL 
 AND carrierid NOT LIKE '%TEST%' AND carrierid NOT LIKE '%TST%'  
 AND clmorigin IN ('T','M','B','R','A','I','J')
 and ( decimal(rxnumber) >= 10000 or (
 sbmsrvprid not in ('1718634','0556540','1497704431','1669498515')
 and srvprovid not in ('1718634','0556540','1497704431','1669498515') ))

 UNION ALL
 
 SELECT 490 AS SRC_ENV_ID,COUNT(*) FROM DWXTRACT2.RCEX1P
WHERE carrierid IS NOT NULL 
 AND carrierid NOT LIKE '%TEST%' AND carrierid NOT LIKE '%TST%'  
 AND clmorigin IN ('T','M','B','R','A','I','J')
 and ( decimal(rxnumber) >= 10000 or (
 sbmsrvprid not in ('1718634','0556540','1497704431','1669498515')
 and srvprovid not in ('1718634','0556540','1497704431','1669498515') ))
;" -column_delimiter "|" >>$DB2_COUNT_FILE
 
##################################################################################################################################################
##Get DB2 CCTA source counts
m_db unload /etl/apps/prod/rxclaim/sand/edw/db_ccta/db/odbc.db_ccta.dbc -select "SELECT 580 AS SRC_ENV_ID,COUNT(*) FROM
( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMPRDEXT.RCEX1P RCEX1P
LEFT JOIN CLMPRDFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMPRDFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMPRDFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL

UNION ALL

--615
SELECT 615 AS SRC_ENV_ID,COUNT(*) FROM
( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMOMCEXT.RCEX1P RCEX1P
LEFT JOIN CLMOMCFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMOMCFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMOMCFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL " -column_delimiter "|" >>$DB2_COUNT_FILE

######################################################################################################################################
##Get DB2 SXCA6 source counts
m_db unload /etl/apps/prod/rxclaim/sand/edw/db_sxca6/db/odbc.db_sxca6.dbc -select "SELECT 500 AS SRC_ENV_SK,COUNT(*) FROM
( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMPRDEXT.RCEX1P RCEX1P

LEFT JOIN CLMPRDFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMPRDFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMPRDFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL


UNION ALL

--560
SELECT 560 AS SRC_ENV_SK,COUNT(*) FROM
( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMCIGEXT.RCEX1P RCEX1P
LEFT JOIN CLMCIGFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMCIGFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMCIGFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL;" -column_delimiter "|" >>$DB2_COUNT_FILE

######################################################################################################################################
##Get DB2 SXCA5 source count
m_db unload /etl/apps/prod/rxclaim/sand/edw/db_sxca5/db/odbc.db_sxca5.dbc -select "SELECT 510 AS SRC_ENV_SK,COUNT(*) FROM
( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMCTREXT.RCEX1P RCEX1P
LEFT JOIN CLMCTRFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMCTRFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMCTRFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL

 
UNION ALL
  
SELECT 620 AS SRC_ENV_SK,COUNT(*) FROM
( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMKSREXT.RCEX1P RCEX1P
LEFT JOIN CLMKSRFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMKSRFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMKSRFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL;" -column_delimiter "|" >>$DB2_COUNT_FILE

######################################################################################################################################
##Get DB2 SXCA2 csource count
m_db unload /etl/apps/prod/rxclaim/sand/edw/db_sxca2/db/odbc.db_sxca2.dbc -select "SELECT 520 AS SRC_ENV_SK,COUNT(*) FROM
( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMNVMEXT.RCE${YEAR_MONTH_DB2} RCEX1P
LEFT JOIN CLMNVMFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMNVMFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMNVMFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
AND CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' AND RCEX1P.DATESBM BETWEEN ${DATE_TWO_DAYS_BACK} AND ${YESTERDAY} -- Change this date everyday with between DAY -2 and DAY -1
 )
WHERE NIAACD_FINAL IS NOT NULL

 UNION ALL

--530
 SELECT 530 AS SRC_ENV_SK,COUNT(*) FROM
( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMINMEXT.RCEX1P RCEX1P
LEFT JOIN CLMINMFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMINMFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMINMFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL

 UNION ALL


--550
 SELECT 550 AS SRC_ENV_SK,COUNT(*) FROM
( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMGAMEXT.RCEX1P RCEX1P
LEFT JOIN CLMGAMFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMGAMFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMGAMFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL

 UNION ALL

--555
SELECT 555 AS SRC_ENV_SK,COUNT(*) FROM
( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMVAHEXT.RCEX1P RCEX1P
LEFT JOIN CLMVAHFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMVAHFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMVAHFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL


UNION ALL

--610
SELECT 610 AS SRC_ENV_SK,COUNT(*) FROM
( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMSDMEXT.RCEX1P RCEX1P
LEFT JOIN CLMSDMFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMSDMFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMSDMFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL

UNION ALL

--640
SELECT 640 AS SRC_ENV_SK,COUNT(*) FROM
( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMAZMEXT.RCEX1P RCEX1P
LEFT JOIN CLMAZMFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMAZMFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMAZMFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL

UNION ALL

SELECT 645 AS SRC_ENV_SK,COUNT(*) FROM
( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMTNMEXT.RCEX1P RCEX1P
LEFT JOIN CLMTNMFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMTNMFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMTNMFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL;" -column_delimiter "|" >>$DB2_COUNT_FILE

######################################################################################################################################

##Metric Validation Section

######################################################################################################################################

######################################################################################################################################
##Get IDW Metric

m_db unload /etl/apps/prod/rxclaim/sand/orca/db_rxclaim/db/netezza.rxclaim.main.dbc -select "SELECT 
'IDW' AS ENV,
SRC_ENV_SK,
CLAIM_STAT_ID,
SBM_DT_SK AS SBM_DT_SK,
COUNT(*) AS CLM_CNT,
SUM(DRG_QTY) AS SUM_DRG_QTY,
SUM(AWP_UNIT_COST) AS SUM_AWP_UNIT_COST,
SUM(APP_INGRED_COST_PAID) AS SUM_APP_INGRED_COST_PAID,
SUM(APP_DISPENSING_FEE) AS SUM_APP_DISPENSING_FEE,
SUM(APP_PATIENT_PAY_AMT) AS SUM_APP_PATIENT_PAY_AMT,
SUM(APP_DUE_AMT) AS SUM_APP_DUE_AMT
FROM ORX_IDW_DM_PRD.ADMIN.F_CLAIM_TRANSACTION WHERE RUN_ID IN ( $IDW_RUN_IDS )
GROUP BY SRC_ENV_SK,CLAIM_STAT_ID,SBM_DT_SK
ORDER BY SRC_ENV_SK,CLAIM_STAT_ID,SBM_DT_SK;" -column_delimiter "|" >>$IDW_METRIC_FILE

######################################################################################################################################
## Get DB2 Bk1 Bk2 Source Metric 

m_db unload /etl/apps/prod/rxclaim/sand/orca/db_orxclaim/db/odbc.db_orxclaim.dbc -select "SELECT 
'DB2' AS ENV,
480 AS SRC_ENV_SK,
CLAIMSTS,
DATESBM AS SBM_DT,
COUNT(*) AS CLM_CNT,
SUM(DECIMALQTY) AS SUM_DRG_QTY,
SUM(AWPUNITCST) AS SUM_AWP_UNIT_COST,
SUM(PHRINGRCST) AS SUM_APP_INGRED_COST_PAID,
SUM(PHRDISPFEE) AS SUM_APP_DISPENSING_FEE,
SUM(PHRPATPAY) AS SUM_APP_PATIENT_PAY_AMT,
SUM(PHRDUEAMT) AS SUM_APP_DUE_AMT
FROM dwxtract.rcex1p 
WHERE carrierid IS NOT NULL 
  AND carrierid NOT LIKE '%TEST%' AND carrierid NOT LIKE '%TST%'  
  AND clmorigin IN ('T','M','B','R','A','I','J')
 and ( decimal(rxnumber) >= 10000 or (
 sbmsrvprid not in ('1718634','0556540','1497704431','1669498515')
 and srvprovid not in ('1718634','0556540','1497704431','1669498515') ))
group by CLAIMSTS,DATESBM  
UNION ALL
SELECT 
'DB2' AS ENV,
490 AS SRC_ENV_SK,
CLAIMSTS,
DATESBM AS SBM_DT,
COUNT(*) AS CLM_CNT,
SUM(DECIMALQTY) AS SUM_DRG_QTY,
SUM(AWPUNITCST) AS SUM_AWP_UNIT_COST,
SUM(PHRINGRCST) AS SUM_APP_INGRED_COST_PAID,
SUM(PHRDISPFEE) AS SUM_APP_DISPENSING_FEE,
SUM(PHRPATPAY) AS SUM_APP_PATIENT_PAY_AMT,
SUM(PHRDUEAMT) AS SUM_APP_DUE_AMT
FROM dwxtract2.rcex1p 
WHERE carrierid IS NOT NULL 
  AND carrierid NOT LIKE '%TEST%' AND carrierid NOT LIKE '%TST%'  
  AND clmorigin IN ('T','M','B','R','A','I','J')
 and ( decimal(rxnumber) >= 10000 or (
 sbmsrvprid not in ('1718634','0556540','1497704431','1669498515')
 and srvprovid not in ('1718634','0556540','1497704431','1669498515') ))  
group by CLAIMSTS,DATESBM" -column_delimiter "|" >>$DB2_METRIC_FILE

######################################################################################################################################
## Get DB2 CCTA Source metric

m_db unload /etl/apps/prod/rxclaim/sand/edw/db_ccta/db/odbc.db_ccta.dbc -select "SELECT 
'DB2' AS ENV,
580 AS SRC_ENV_SK,
CLAIMSTS,
DATESBM AS SBM_DT,
COUNT(*) AS CLM_CNT,
SUM(DECIMALQTY) AS SUM_DRG_QTY,
SUM(AWPUNITCST) AS SUM_AWP_UNIT_COST,
SUM(PHRINGRCST) AS SUM_APP_INGRED_COST_PAID,
SUM(PHRDISPFEE) AS SUM_APP_DISPENSING_FEE,
SUM(PHRPATPAY) AS SUM_APP_PATIENT_PAY_AMT,
SUM(PHRDUEAMT) AS SUM_APP_DUE_AMT
FROM
( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMPRDEXT.RCEX1P RCEX1P
LEFT JOIN CLMPRDFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMPRDFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMPRDFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 ) 
WHERE NIAACD_FINAL IS NOT NULL
group by CLAIMSTS, DATESBM
UNION ALL
 SELECT 
'DB2' AS ENV,
615 AS SRC_ENV_SK,
CLAIMSTS,
DATESBM AS SBM_DT,
COUNT(*) AS CLM_CNT,
SUM(DECIMALQTY) AS SUM_DRG_QTY,
SUM(AWPUNITCST) AS SUM_AWP_UNIT_COST,
SUM(PHRINGRCST) AS SUM_APP_INGRED_COST_PAID,
SUM(PHRDISPFEE) AS SUM_APP_DISPENSING_FEE,
SUM(PHRPATPAY) AS SUM_APP_PATIENT_PAY_AMT,
SUM(PHRDUEAMT) AS SUM_APP_DUE_AMTT
FROM
( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMOMCEXT.RCEX1P RCEX1P
LEFT JOIN CLMOMCFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMOMCFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMOMCFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 ) 
WHERE NIAACD_FINAL IS NOT NULL
group by CLAIMSTS,DATESBM
ORDER BY SBM_DT,CLAIMSTS;" -column_delimiter "|" >> $DB2_METRIC_FILE

######################################################################################################################################
## Get DB2 SXCA6 source metric
m_db unload /etl/apps/prod/rxclaim/sand/edw/db_sxca6/db/odbc.db_sxca6.dbc -select "SELECT 
'DB2' AS ENV,
500 AS SRC_ENV_SK,
CLAIMSTS,
DATESBM AS SBM_DT,
COUNT(*) AS CLM_CNT,
SUM(DECIMALQTY) AS SUM_DRG_QTY,
SUM(AWPUNITCST) AS SUM_AWP_UNIT_COST,
SUM(PHRINGRCST) AS SUM_APP_INGRED_COST_PAID,
SUM(PHRDISPFEE) AS SUM_APP_DISPENSING_FEE,
SUM(PHRPATPAY) AS SUM_APP_PATIENT_PAY_AMT,
SUM(PHRDUEAMT) AS SUM_APP_DUE_AMT
FROM ( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMPRDEXT.RCEX1P RCEX1P

LEFT JOIN CLMPRDFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMPRDFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMPRDFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL
GROUP BY CLAIMSTS,DATESBM
UNION ALL
SELECT 
'DB2' AS ENV,
560 AS SRC_ENV_SK,
CLAIMSTS,
DATESBM AS SBM_DT,
COUNT(*) AS CLM_CNT,
SUM(DECIMALQTY) AS SUM_DRG_QTY,
SUM(AWPUNITCST) AS SUM_AWP_UNIT_COST,
SUM(PHRINGRCST) AS SUM_APP_INGRED_COST_PAID,
SUM(PHRDISPFEE) AS SUM_APP_DISPENSING_FEE,
SUM(PHRPATPAY) AS SUM_APP_PATIENT_PAY_AMT,
SUM(PHRDUEAMT) AS SUM_APP_DUE_AMT
FROM ( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMCIGEXT.RCEX1P RCEX1P

LEFT JOIN CLMCIGFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMCIGFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMCIGFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL 
GROUP BY CLAIMSTS,DATESBM
ORDER BY SBM_DT,CLAIMSTS;" -column_delimiter "|" >> $DB2_METRIC_FILE

######################################################################################################################################
## Get DB2 SXCA5 source metric
m_db unload /etl/apps/prod/rxclaim/sand/edw/db_sxca5/db/odbc.db_sxca5.dbc -select "SELECT 
'DB2' AS ENV,
510 AS SRC_ENV_SK,
CLAIMSTS,
DATESBM AS SBM_DT,
COUNT(*) AS CLM_CNT,
SUM(DECIMALQTY) AS SUM_DRG_QTY,
SUM(AWPUNITCST) AS SUM_AWP_UNIT_COST,
SUM(PHRINGRCST) AS SUM_APP_INGRED_COST_PAID,
SUM(PHRDISPFEE) AS SUM_APP_DISPENSING_FEE,
SUM(PHRPATPAY) AS SUM_APP_PATIENT_PAY_AMT,
SUM(PHRDUEAMT) AS SUM_APP_DUE_AMT
FROM 
( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMCTREXT.RCEX1P RCEX1P
LEFT JOIN CLMCTRFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMCTRFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMCTRFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL
GROUP BY CLAIMSTS,DATESBM
UNION ALL
SELECT 
 'DB2' AS ENV,
620 AS SRC_ENV_SK,
CLAIMSTS,
DATESBM AS SBM_DT,
COUNT(*) AS CLM_CNT,
SUM(DECIMALQTY) AS SUM_DRG_QTY,
SUM(AWPUNITCST) AS SUM_AWP_UNIT_COST,
SUM(PHRINGRCST) AS SUM_APP_INGRED_COST_PAID,
SUM(PHRDISPFEE) AS SUM_APP_DISPENSING_FEE,
SUM(PHRPATPAY) AS SUM_APP_PATIENT_PAY_AMT,
SUM(PHRDUEAMT) AS SUM_APP_DUE_AMT
FROM
(
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMKSREXT.RCEX1P RCEX1P
LEFT JOIN CLMKSRFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMKSRFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMKSRFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL
GROUP BY CLAIMSTS,DATESBM
ORDER BY SBM_DT,CLAIMSTS;" -column_delimiter "|" >> $DB2_METRIC_FILE

######################################################################################################################################
## Get DB2 SXCA2 source metric

m_db unload /etl/apps/prod/rxclaim/sand/edw/db_sxca2/db/odbc.db_sxca2.dbc -select "SELECT 
 'DB2' AS ENV,
520 AS SRC_ENV_SK,
CLAIMSTS,
DATESBM AS SBM_DT,
COUNT(*) AS CLM_CNT,
SUM(DECIMALQTY) AS SUM_DRG_QTY,
SUM(AWPUNITCST) AS SUM_AWP_UNIT_COST,
SUM(PHRINGRCST) AS SUM_APP_INGRED_COST_PAID,
SUM(PHRDISPFEE) AS SUM_APP_DISPENSING_FEE,
SUM(PHRPATPAY) AS SUM_APP_PATIENT_PAY_AMT,
SUM(PHRDUEAMT) AS SUM_APP_DUE_AMT
FROM ( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMNVMEXT.RCE${YEAR_MONTH_DB2} RCEX1P

LEFT JOIN CLMNVMFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMNVMFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMNVMFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' AND RCEX1P.DATESBM BETWEEN ${DATE_TWO_DAYS_BACK} AND ${YESTERDAY} 
 )
WHERE NIAACD_FINAL IS NOT NULL
GROUP BY CLAIMSTS,DATESBM
UNION ALL
SELECT 
 'DB2' AS ENV,
530 AS SRC_ENV_SK,
CLAIMSTS,
DATESBM AS SBM_DT,
COUNT(*) AS CLM_CNT,
SUM(DECIMALQTY) AS SUM_DRG_QTY,
SUM(AWPUNITCST) AS SUM_AWP_UNIT_COST,
SUM(PHRINGRCST) AS SUM_APP_INGRED_COST_PAID,
SUM(PHRDISPFEE) AS SUM_APP_DISPENSING_FEE,
SUM(PHRPATPAY) AS SUM_APP_PATIENT_PAY_AMT,
SUM(PHRDUEAMT) AS SUM_APP_DUE_AMT
FROM ( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMINMEXT.RCEX1P RCEX1P
LEFT JOIN CLMINMFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMINMFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMINMFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL
GROUP BY CLAIMSTS,DATESBM
UNION ALL
SELECT 
 'DB2' AS ENV,
550 AS SRC_ENV_SK,
CLAIMSTS,
DATESBM AS SBM_DT,
COUNT(*) AS CLM_CNT,
SUM(DECIMALQTY) AS SUM_DRG_QTY,
SUM(AWPUNITCST) AS SUM_AWP_UNIT_COST,
SUM(PHRINGRCST) AS SUM_APP_INGRED_COST_PAID,
SUM(PHRDISPFEE) AS SUM_APP_DISPENSING_FEE,
SUM(PHRPATPAY) AS SUM_APP_PATIENT_PAY_AMT,
SUM(PHRDUEAMT) AS SUM_APP_DUE_AMT
FROM ( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMGAMEXT.RCEX1P RCEX1P
LEFT JOIN CLMGAMFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMGAMFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMGAMFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL
GROUP BY CLAIMSTS,DATESBM
UNION ALL
SELECT 
 'DB2' AS ENV,
555 AS SRC_ENV_SK,
CLAIMSTS,
DATESBM AS SBM_DT,
COUNT(*) AS CLM_CNT,
SUM(DECIMALQTY) AS SUM_DRG_QTY,
SUM(AWPUNITCST) AS SUM_AWP_UNIT_COST,
SUM(PHRINGRCST) AS SUM_APP_INGRED_COST_PAID,
SUM(PHRDISPFEE) AS SUM_APP_DISPENSING_FEE,
SUM(PHRPATPAY) AS SUM_APP_PATIENT_PAY_AMT,
SUM(PHRDUEAMT) AS SUM_APP_DUE_AMT
FROM ( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMVAHEXT.RCEX1P RCEX1P
LEFT JOIN CLMVAHFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMVAHFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMVAHFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL
GROUP BY CLAIMSTS,DATESBM
UNION ALL
SELECT 
 'DB2' AS ENV,
610 AS SRC_ENV_SK,
CLAIMSTS,
DATESBM AS SBM_DT,
COUNT(*) AS CLM_CNT,
SUM(DECIMALQTY) AS SUM_DRG_QTY,
SUM(AWPUNITCST) AS SUM_AWP_UNIT_COST,
SUM(PHRINGRCST) AS SUM_APP_INGRED_COST_PAID,
SUM(PHRDISPFEE) AS SUM_APP_DISPENSING_FEE,
SUM(PHRPATPAY) AS SUM_APP_PATIENT_PAY_AMT,
SUM(PHRDUEAMT) AS SUM_APP_DUE_AMT
FROM ( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMSDMEXT.RCEX1P RCEX1P
LEFT JOIN CLMSDMFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMSDMFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMSDMFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL
GROUP BY CLAIMSTS,DATESBM
UNION ALL  
SELECT 
 'DB2' AS ENV,
640 AS SRC_ENV_SK,
CLAIMSTS,
DATESBM AS SBM_DT,
COUNT(*) AS CLM_CNT,
SUM(DECIMALQTY) AS SUM_DRG_QTY,
SUM(AWPUNITCST) AS SUM_AWP_UNIT_COST,
SUM(PHRINGRCST) AS SUM_APP_INGRED_COST_PAID,
SUM(PHRDISPFEE) AS SUM_APP_DISPENSING_FEE,
SUM(PHRPATPAY) AS SUM_APP_PATIENT_PAY_AMT,
SUM(PHRDUEAMT) AS SUM_APP_DUE_AMT
FROM ( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMAZMEXT.RCEX1P RCEX1P
LEFT JOIN CLMAZMFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMAZMFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMAZMFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL
GROUP BY CLAIMSTS,DATESBM
UNION ALL
SELECT 
 'DB2' AS ENV,
645 AS SRC_ENV_SK,
CLAIMSTS,
DATESBM AS SBM_DT,
COUNT(*) AS CLM_CNT,
SUM(DECIMALQTY) AS SUM_DRG_QTY,
SUM(AWPUNITCST) AS SUM_AWP_UNIT_COST,
SUM(PHRINGRCST) AS SUM_APP_INGRED_COST_PAID,
SUM(PHRDISPFEE) AS SUM_APP_DISPENSING_FEE,
SUM(PHRPATPAY) AS SUM_APP_PATIENT_PAY_AMT,
SUM(PHRDUEAMT) AS SUM_APP_DUE_AMT
FROM ( 
SELECT  DISTINCT RCEX1P.*,
CASE WHEN RCCESP.NIAACD IS NOT NULL THEN RCCESP.NIAACD
     WHEN (RCCESP1.NIAACD IS NULL AND RCCESP2.NIAACD IS NOT NULL) THEN RCCESP2.NIAACD  
     ELSE NULL END AS NIAACD_FINAL
     
FROM CLMTNMEXT.RCEX1P RCEX1P
LEFT JOIN CLMTNMFIL.RCCESP RCCESP
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP.NIAACD)
   AND RCCESP.NIIYC3='Y'
   
LEFT JOIN CLMTNMFIL.RCCESP RCCESP1
    ON TRIM(RCEX1P.CARRIERID)=TRIM(RCCESP1.NIAACD)
   AND RCCESP1.NIIYC3='N'
   
LEFT JOIN CLMTNMFIL.RCCESP RCCESP2
    ON '*DEFAULT'=TRIM(RCCESP2.NIAACD)
   AND RCCESP2.NIIYC3='Y'
   
WHERE CARRIERID IS NOT NULL AND  TRIM(CARRIERID) <> '' 
 )
WHERE NIAACD_FINAL IS NOT NULL
GROUP BY CLAIMSTS,DATESBM
ORDER BY SBM_DT,CLAIMSTS;" -column_delimiter "|" >> $DB2_METRIC_FILE
