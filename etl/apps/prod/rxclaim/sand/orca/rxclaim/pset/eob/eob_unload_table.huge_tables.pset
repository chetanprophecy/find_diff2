!prototype|P|||$AI_MP/eob/eob_unload_table.mp
SQL|c|||WITH \r\nV_DMMDE  AS ( SELECT \r\n              MMDE_TEMP.MBR_SK,\r\n                MMDE_TEMP.MMD_FROM_DT,\r\n                MMDE_TEMP.MMD_THRU_DT,\r\n                MMDE_TEMP.MMD_COPAY_CATEGORY \r\n\t\t\t\t FROM (    SELECT   m.MBR_SK,                                                      \r\n                                                        m.MMD_FROM_DT,\r\n                                                        m.MMD_THRU_DT,\r\n                                                        m.MMD_COPAY_CATEGORY,\r\n                                                        ROW_NUMBER() OVER ( PARTITION BY m.mbr_sk  ORDER BY m.mbr_sk, m.MMD_SEQ_NBR) RNUM\r\n                                                FROM ${DB_RXCLAIM_DB_NAME}..D_MMD_MEMBER_ELIGIBILITY m  \r\n                                                INNER JOIN ${DB_RXCLAIM_DB_NAME}..d_date d1 on (m.MMD_FROM_DT = d1.CAL_DAY_DT  )\r\n                                                INNER JOIN ${DB_RXCLAIM_DB_NAME}..d_date d2 on (m.MMD_THRU_DT = d2.CAL_DAY_DT  )\r\n                                                WHERE   m.CARRIER_ID IN (${CARRIER_ID_LIST})    AND\r\n                                                (D1.CAL_YR_MNTH_ID <=${UNLOAD_YEAR_MONTH} AND D2.CAL_YR_MNTH_ID>=${UNLOAD_YEAR_MONTH})\r\n\t\t\t\t\t\t\t\t\t\t\t\t\r\n                                                    \r\n                                         ) MMDE_TEMP \r\n        WHERE\r\n                RNUM=1\r\n)\r\nSELECT DMEM.MBR_SK AS DMEM_MBR_SK,\r\nDMEM.ACCOUNT_ID AS DMEM_ACCOUNT_ID,\r\nDMEM.CARRIER_ID AS DMEM_CARRIER_ID,\r\nDMEM.EMPLOYER_GROUP_ID AS DMEM_EMPLOYER_GROUP_ID,\r\nDMEM.MB_FIRST_NM AS DMEM_MB_FIRST_NM,\r\nDMEM.MB_LAST_NM AS DMEM_MB_LAST_NM,\r\nDMEM.MB_MID_INIT_NM AS DMEM_MB_MID_INIT_NM,\r\nDMEM.MBR_ADDR1 AS DMEM_MBR_ADDR1,\r\nDMEM.MBR_ADDR2 AS DMEM_MBR_ADDR2,\r\nDMEM.MBR_ADDR3 AS DMEM_MBR_ADDR3,\r\nDMEM.MBR_CITY_NM AS DMEM_MBR_CITY_NM,\r\nDMEM.MBR_ID AS DMEM_MBR_ID,\r\nDMEM.MBR_LANG_CD AS DMEM_MBR_LANG_CD,\r\nDMEM.MBR_ST_CD AS DMEM_MBR_ST_CD,\r\nDMEM.MBR_ZIP AS DMEM_MBR_ZIP,\r\nDMEM.MBR_ZIP2 AS DMEM_MBR_ZIP2,\r\nDMA.FLD_VALUE AS DMA_FLD_VALUE,\r\nDME.CLT_PROD_CD AS DME_CLT_PROD_CD,\r\nFCA.SAV_ACCT_AMT AS FCA_SAV_ACCT_AMT,\r\nFCLM.BIN_NBR AS FCLM_BIN_NBR,\r\nFCLM.GRP_NBR_SUBMD AS FCLM_GRP_NBR_SUBMD,\r\nFCLM.PROCESSOR_CNTRL_NBR AS FCLM_PROCESSOR_CNTRL_NBR,\r\nFCLM.TROOP_AMT AS FCLM_TROOP_AMT,\r\nFCLM.PLN_DRG_STAT_SK AS FCLM_PLN_DRG_STAT_SK,\r\nFCLM.SBM_USUAL_CUSTOMARY_AMT AS FCLM_SBM_USUAL_CUSTOMARY_AMT,\r\nFCLM.COVERAGE_LVL_IND AS FCLM_COVERAGE_LVL_IND,\r\nFMPD.CAG_SK AS FMPD_CAG_SK,\r\nFMPD.AMT_TWD_PLAN_CAT_AMT AS FMPD_AMT_TWD_PLAN_CAT_AMT,\r\nFMPD.AMT_TWD_PLAN_DED_AMT AS FMPD_AMT_TWD_PLAN_DED_AMT,\r\nFMPD.AMT_TWD_PLAN_GAP_AMT AS FMPD_AMT_TWD_PLAN_GAP_AMT,\r\n(CASE WHEN FMPD.COPAY_CATGRY_CD='-' THEN   DMMDE.MMD_COPAY_CATEGORY ELSE  FMPD.COPAY_CATGRY_CD  END) AS FMPD_COPAY_CATGRY_CD,\r\nFMPD.DRG_SPND_AMT AS FMPD_DRG_SPND_AMT,\r\nFMPD.DRG_SPND_TWD_DED_AMT AS FMPD_DRG_SPND_TWD_DED_AMT,\r\nFMPD.DRG_SPND_TWD_GAP_AMT AS FMPD_DRG_SPND_TWD_GAP_AMT,\r\nFMPD.DRG_SPND_TWD_INIT_COV_AMT AS FMPD_DRG_SPND_TWD_INIT_COV_AMT,\r\nFMPD.GAP_BRND_DISC_AMT AS FMPD_GAP_BRND_DISC_AMT,\r\nFMPD.LICS_AMT AS FMPD_LICS_AMT,\r\nFMPD.MBR_AMT_TWD_DED_AMT AS FMPD_MBR_AMT_TWD_DED_AMT,\r\nFMPD.MBR_AMT_TWD_GAP_AMT AS FMPD_MBR_AMT_TWD_GAP_AMT,\r\nFMPD.MBR_AMT_TWD_INIT_COV_AMT AS FMPD_MBR_AMT_TWD_INIT_COV_AMT,\r\nFMPD.PHR_PATIENT_PAY_AMT AS FMPD_PHR_PATIENT_PAY_AMT,\r\nFMPD.PLAN_INIT_COV_AMT AS FMPD_PLAN_INIT_COV_AMT,\r\nFMPD.PLAN_PAY_INIT_COV_LVL_AMT AS FMPD_PLAN_PAY_INIT_COV_LVL_AMT,\r\nFMPD.CLAIM_NBR AS FMPD_CLAIM_NBR,\r\nFMPD.CLAIM_SEQ_NBR AS FMPD_CLAIM_SEQ_NBR,\r\nFMPD.CLAIM_STAT_ID AS FMPD_CLAIM_STAT_ID,\r\nFMPD.TC3_SRV_PROV_ID AS FMPD_TC3_SRV_PROV_ID,\r\nFMPD.OUT_OF_NETWK_CD  AS FMPD_OUT_OF_NETWK_CD ,\r\nFMPD.REFILL_NBR  AS FMPD_REFILL_NBR ,\r\nFMPD.SBM_SRV_DT AS FMPD_SBM_SRV_DT,\r\nFMPD.SBM_DT AS FMPD_SBM_DT,\r\nFMPD.DRG_QTY AS FMPD_DRG_QTY,\r\nFMPD.DAYS_SPLY  AS FMPD_DAYS_SPLY ,\r\nFMPD.CLT_PATIENT_PAY_AMT AS FMPD_CLT_PATIENT_PAY_AMT,\r\nCAST(FCLM.TIER_LEVEL AS CHARACTER VARYING(2)) AS FMPD_TIER_IND,\r\nFMPD.CLT_DUE_AMT AS FMPD_CLT_DUE_AMT,\r\nFMPD.DRG_SPND_AMT  AS FMPD_DRG_SPND_AMT ,\r\nFMPD.DRG_COV_STAT_CD AS FMPD_DRG_COV_STAT_CD,\r\nFMPD.EGWP_AMT_TWD_PLAN_DED_AMT AS FMPD_EGWP_AMT_TWD_PLAN_DED_AMT,\r\nFMPD.EGWP_AMT_TWD_PLAN_GAP_AMT AS FMPD_EGWP_AMT_TWD_PLAN_GAP_AMT,\r\nFMPD.EGWP_AMT_TWD_PLAN_CAT_AMT AS FMPD_EGWP_AMT_TWD_PLAN_CAT_AMT,\r\n\r\n\r\nFMPD.EGWP_DED_MBR_PAY_AMT AS FMPD_EGWP_DED_MBR_PAY_AMT,\r\nFMPD.EGWP_DED_DRG_SPND_AMT AS FMPD_EGWP_DED_DRG_SPND_AMT,\r\nFMPD.EGWP_CG_MBR_PAY_AMT AS FMPD_EGWP_CG_MBR_PAY_AMT,\r\nFMPD.EGWP_CG_DRG_SPND_AMT AS FMPD_EGWP_CG_DRG_SPND_AMT,\r\nFMPD.EGWP_CAT_MBR_PAY_AMT AS FMPD_EGWP_CAT_MBR_PAY_AMT,\r\nFMPD.EGWP_CAT_DRG_SPND_AMT AS FMPD_EGWP_CAT_DRG_SPND_AMT,\r\nFMPD.EGWP_ICL_MBR_PAY_AMT AS FMPD_EGWP_ICL_MBR_PAY_AMT,\r\nFMPD.EGWP_ICL_DRG_SPND_AMT AS FMPD_EGWP_ICL_DRG_SPND_AMT,\r\nFMPD.EGWP_TROOP_SCHED_ID AS FMPD_EGWP_TROOP_SCHED_ID,\r\nFMPD.EGWP_TROOP_SCHED_STEP_NO AS FMPD_EGWP_TROOP_SCHED_STEP_NO,\r\nFMPD.EGWP_DEDLVL_DRG_SPND_AMT AS FMPD_EGWP_DEDLVL_DRG_SPND_AMT,\r\nFMPD.EGWP_DEDLVL_TROOP_AMT AS FMPD_EGWP_DEDLVL_TROOP_AMT,\r\nFMPD.EGWP_PLAN_GAP_AMT AS FMPD_EGWP_PLAN_GAP_AMT,\r\nFMPD.EGWP_PLAN_CAT_AMT AS FMPD_EGWP_PLAN_CAT_AMT,\r\nFMPD.EGWP_PLAN_ICL_AMT AS FMPD_EGWP_PLAN_ICL_AMT,\r\nFMPD.EGWP_PLAN_PAY_ICL_AMT AS FMPD_EGWP_PLAN_PAY_ICL_AMT,\r\n\r\nFMPD.RX_NBR  AS FMPD_RX_NBR ,\r\nFMPD.TC4_PLAN_EFF_DT AS FMPD_TC4_PLAN_EFF_DT,\r\nFMPD.FORMULARY_CD AS FMPD_FORMULARY_CD,\r\nFMPD.CONTRACT_PBP_SK AS FMPD_CONTRACT_PBP_SK,\r\nFMPD.PHR_SK AS FMPD_PHR_SK,\r\nFMPD.PROD_SK AS FMPD_PROD_SK,\r\nFMPD.SBM_DT AS FMPD_SBM_DT,\r\nFMPD.COB_IND AS FMPD_COB_IND,\r\nFMPD.PHR_OTH_PYR_RECOG_AMT AS FMPD_PHR_OTH_PYR_RECOG_AMT,\r\nFMPD.MOOP_MBR_PAY_AMT AS FMPD_MOOP_MBR_PAY_AMT,\r\nFMPD.PHR_VACC_ADM_FEE_AMT AS FMPD_PHR_VACC_ADM_FEE_AMT,\r\nFMPD.MBR_HICN_ID AS FMPD_MBR_HICN_ID,\r\nFMPD.COMPOUND_CD AS FMPD_COMPOUND_CD,\r\nFMPD.PHR_INGRED_COST_PAID AS FMPD_PHR_INGRED_COST_PAID,\r\nFMPD.PHR_SALES_TAX_PAID AS FMPD_PHR_SALES_TAX_PAID,\r\nFMPD.PHR_DISPENSING_FEE AS FMPD_PHR_DISPENSING_FEE,\r\nFMPD.BEGIN_BENEFIT_PHASE_SK AS FMPD_BEGIN_BENEFIT_PHASE_SK,\r\nFMPD.END_BENEFIT_PHASE_SK AS FMPD_END_BENEFIT_PHASE_SK,\r\nFMPD.INSERT_TS AS FMPD_INSERT_TS,\r\nFMPD.UPDATE_TS AS FMPD_UPDATE_TS,\r\nFMPD.DED_LVL_DRG_SPND_AMT AS FMPD_DED_LVL_DRG_SPND_AMT\r\nFROM\r\n${DB_RXCLAIM_DB_NAME}..F_MPD_CLAIM_TRANSACTION FMPD\r\nINNER JOIN ${DB_RXCLAIM_DB_NAME}..D_MEMBER DMEM\r\nON\r\nDMEM.MBR_SK = FMPD.MBR_SK AND\r\n( ( FMPD.SBM_DT_SK BETWEEN '${START_SUBMIT_DATE}' AND '${END_SUBMIT_DATE}' AND FMPD.FILLED_DT_SK BETWEEN '${YEAR_START_DATE}' AND '${YEAR_END_DATE}' ) ${INSERT_TS_CONDITION} ) AND\r\nFMPD.CLAIM_STAT_ID IN (${CLAIM_STAT_ID}) AND\r\nFMPD.SRC_ENV_SK IN (${SRC_ENV_SK}) AND\r\nDMEM.CARRIER_ID IN (${CARRIER_ID_LIST})\r\n${MEMBER_ID_LIST}\r\nINNER JOIN ${DB_RXCLAIM_DB_NAME}..F_CLAIM_TRANSACTION FCLM\r\nON\r\nFCLM.CLAIM_NBR = FMPD.CLAIM_NBR AND\r\nFCLM.CLAIM_SEQ_NBR = FMPD.CLAIM_SEQ_NBR AND\r\nFCLM.CLAIM_STAT_ID = FMPD.CLAIM_STAT_ID AND\r\nFCLM.SRC_ENV_SK = FMPD.SRC_ENV_SK AND\r\n--FCLM.SBM_DT_SK BETWEEN '${START_SUBMIT_DATE}' AND '${END_SUBMIT_DATE}'\r\nFCLM.SBM_DT_SK BETWEEN '${YEAR_START_DATE}' AND '${END_SUBMIT_DATE}'\r\nLEFT OUTER JOIN  (\r\nSELECT * FROM \r\n(\r\n        SELECT DME_TEMP.MBR_SK,\r\n                DME_TEMP.CAG_SK,\r\n                DME_TEMP.MEL_EFF_DT,\r\n                DME_TEMP.MEL_THRU_DT,\r\n                DME_TEMP.CLT_PROD_CD , \r\n                ROW_NUMBER() OVER (PARTITION BY DME_TEMP.CARRIER_ID, DME_TEMP.ACCOUNT_ID, DME_TEMP.EMPLOYER_GROUP_ID, DME_TEMP.MBR_ID\r\n                ORDER BY DME_TEMP.CARRIER_ID, DME_TEMP.ACCOUNT_ID, DME_TEMP.EMPLOYER_GROUP_ID, DME_TEMP.MBR_ID, DME_TEMP.SEQ_NBR) RNUM\r\n                FROM ${DB_RXCLAIM_DB_NAME}..D_MEMBER_ELIGIBILITY DME_TEMP\r\n                WHERE   DME_TEMP.MEL_STAT_CD = 'A' AND\r\n                        DME_TEMP.MEL_EFF_DT <= to_date('${UNLOAD_YEAR_MONTH}','YYYYMM') AND\r\n                        DME_TEMP.MEL_THRU_DT >= to_date('${UNLOAD_YEAR_MONTH}','YYYYMM') AND\r\n                        DME_TEMP.CARRIER_ID IN (${CARRIER_ID_LIST}) \r\n) MEL WHERE MEL.RNUM =1 ) AS DME\r\nON\r\n\r\nFMPD.MBR_SK = DME.MBR_SK AND\r\nFMPD.CAG_SK = DME.CAG_SK AND\r\nFMPD.SBM_DT BETWEEN DME.MEL_EFF_DT AND DME.MEL_THRU_DT\r\nLEFT OUTER JOIN ${DB_RXCLAIM_DB_NAME}..D_MEMBER_ANCILARY DMA\r\nON\r\nDMA.CURR_IND = 'Y' AND\r\nFMPD.MBR_SK = DMA.MBR_SK  AND\r\nFMPD.CAG_SK = DMA.CAG_SK  AND--IS THIS REQUIRED THIS IS NOT PART OF NATURAL KEY\r\nFMPD.SBM_DT BETWEEN DMA.EFF_FRM_DT AND DMA.EFF_THRU_DT\r\n--AND DMA.CURR_IND='Y'\r\nLEFT OUTER JOIN ${DB_RXCLAIM_DB_NAME}..F_CLAIM_ADJUSTMENT FCA\r\nON\r\nFMPD.CLAIM_NBR = FCA.CLAIM_NBR AND\r\nFMPD.CLAIM_SEQ_NBR = FCA.CLAIM_SEQ_NBR AND\r\nFMPD.CAG_SK = FCA.CAG_SK AND\r\nFMPD.MBR_SK = FCA.MBR_SK AND\r\nFMPD.SRC_ENV_SK = FCA.SRC_ENV_SK\r\n\r\nLEFT OUTER JOIN V_DMMDE AS DMMDE \r\nON\r\nFMPD.COPAY_CATGRY_CD ='-' AND \r\nFMPD.MBR_SK = DMMDE.MBR_SK AND\r\nFMPD.SBM_DT BETWEEN DMMDE.MMD_FROM_DT AND DMMDE.MMD_THRU_DT\r\n\r\n;
UNLOAD_FILE_NAME||||unload.eob_huge_tables.$RUN_ID.$UNLOAD_YEAR_MONTH.dat.gz
SQL_DML|f|||$AI_DML/eob/unload.eob_huge_tables.dml
CLAIM_STAT_ID||||'P','X','R'
RUN_ID||||20190109000000
UNLOAD_YEAR_MONTH||||201903
CARRIER_ID_LIST||||$[string_join(APPENDIX_A_CARRIERS,",")]
SRT_KEY|$|||{dmem_carrier_id; dmem_mbr_id; fmpd_claim_nbr; fmpd_claim_seq_nbr; fmpd_claim_stat_id descending}
HISTORY_RUN||||False
RXCLAIM_DBC|f|||$DB_RXCLAIM_DBC
END_SUBMIT_DATE||||$[\r\n(date("YYYYMMDD"))datetime_add((date("YYYYMMDD"))string_concat(\r\n        UNLOAD_YEAR_MONTH,\r\n        (decimal(2))date_month_end(//Find Months Last Day\r\n                        (decimal(2))string_substring(UNLOAD_YEAR_MONTH,5,6),//Passing Month\r\n                        (decimal(4))string_substring(UNLOAD_YEAR_MONTH,1,4)//Passing Year\r\n                                  )\r\n              ),1)\r\n\r\n\r\n\r\n]
START_SUBMIT_DATE||||$[\r\n\r\n(date("YYYYMMDD"))datetime_add((date("YYYYMMDD"))\r\nstring_concat(UNLOAD_YEAR_MONTH,"01"),-1)]
UNLOAD_INTERFACE|l|||external_table
