!prototype|P|||$AI_MP/eob/eob_unload_table.mp
SQL|c|||WITH VM_MADP_ALL AS (\r\n\t\tselect CARRIER_ID,\r\n\t\t\t\tMBR_ID,  max(MAD_ADJTMNT_DT) MAD_ADJTMNT_DT,\r\n\t\t\t\tSUM(CASE WHEN MAD_BEN_DED_TYP_CD='S' THEN MAD_ADJTMNT_AMT END) AS YR_MAD_ADJTMNT_AMT_S,\r\n\t\t\t\tSUM(CASE WHEN MAD_BEN_DED_TYP_CD='T' THEN MAD_ADJTMNT_AMT END) AS YR_MAD_ADJTMNT_AMT_T\r\n\t\tFROM \r\n\t\t\t( SELECT  \r\n                                DISTINCT \r\n                                CARRIER_ID , MBR_ID, MAD_BEN_DED_TYP_CD,MAD_ADJTMNT_DT,\r\n\t-- FIRST_VALUE(MAD_ADJTMNT_AMT)  OVER (PARTITION BY CARRIER_ID,MBR_ID,MAD_BEN_DED_TYP_CD ORDER BY CARRIER_ID,MBR_ID,MAD_BEN_DED_TYP_CD,MAD_SEQ_NBR DESC ) AS \r\n                                MAD_ADJTMNT_AMT \r\n\t\t\t\t\tFROM    ${DB_RXCLAIM_DB_NAME}..L_EOB_MADP\r\n\t\t\t\twhere \r\n\t\t\t\tMAD_STAT_CD= 'A' AND MAD_SENDER_TYP_CD='U'\r\n\t\t\t\tAND mad_adjtmnt_dt between '${YEAR_START_DATE}' and '${END_SUBMIT_DATE}' )  A\r\n GROUP BY 1,2 )\r\n,\r\n VM_MADP AS (\r\nselect CARRIER_ID,MBR_ID,\r\nMAX( CASE WHEN MAD_SENDER_TYP_CD='F' THEN MAD_ADJTMNT_DT END) AS MAD_ADJTMNT_DT,\r\nSUM(CASE WHEN MAD_BEN_DED_TYP_CD='S' and MAD_SENDER_TYP_CD='F' THEN MAD_ADJTMNT_AMT END) AS MAD_ADJTMNT_AMT_S,\r\nSUM(CASE WHEN MAD_BEN_DED_TYP_CD='T' and MAD_SENDER_TYP_CD='F' THEN MAD_ADJTMNT_AMT END) AS MAD_ADJTMNT_AMT_T,\r\nSUM(CASE WHEN MAD_BEN_DED_TYP_CD='S' AND to_char(MAD_ADJTMNT_DT,'YYYYMM')='${UNLOAD_YEAR_MONTH}' THEN MAD_ADJTMNT_AMT END) AS MTD_MAD_ADJTMNT_AMT_S,\r\nSUM(CASE WHEN MAD_BEN_DED_TYP_CD='T' AND to_char(MAD_ADJTMNT_DT,'YYYYMM')='${UNLOAD_YEAR_MONTH}' THEN MAD_ADJTMNT_AMT END) AS MTD_MAD_ADJTMNT_AMT_T\r\nFROM    ${DB_RXCLAIM_DB_NAME}..L_EOB_MADP\r\nwhere \r\nMAD_STAT_CD= 'A' AND \r\n--year(mad_adjtmnt_dt) = year(to_date('${UNLOAD_YEAR_MONTH}','YYYYMM'))\r\nmad_adjtmnt_dt between '${YEAR_START_DATE}' and '${END_SUBMIT_DATE}'\r\nGROUP BY 1,2 ),\r\n\r\nVM_DMMD AS\r\n(SELECT *\r\n                   FROM   (SELECT DMMD_TEMP.MBR_SK,\r\n                                  DMMD_TEMP.MMD_COPAY_CATEGORY,\r\n                                  DMMD_TEMP.MMD_FROM_DT,\r\n                                  DMMD_TEMP.MMD_THRU_DT,\r\n\t\t\t\t\t\t\t\t  VM_MADP.MAD_ADJTMNT_DT ,\r\n                                  ROW_NUMBER()\r\n                                    OVER (\r\n                                      PARTITION BY DMMD_TEMP.CARRIER_ID,\r\n                                    DMMD_TEMP.ACCOUNT_ID,\r\n                                    DMMD_TEMP.EMPLOYER_GROUP_ID,\r\n                                    DMMD_TEMP.MBR_ID\r\n                                      ORDER BY DMMD_TEMP.CARRIER_ID,\r\n                                    DMMD_TEMP.ACCOUNT_ID,\r\n                                    DMMD_TEMP.EMPLOYER_GROUP_ID,\r\n                                    DMMD_TEMP.MBR_ID,\r\n                                    DMMD_TEMP.MMD_SEQ_NBR)\r\n                                          RNUM\r\n                           FROM   ${DB_RXCLAIM_DB_NAME}..D_MMD_MEMBER_ELIGIBILITY DMMD_TEMP \r\n\t\t\t\t\t\t \r\n\t\t\t\t\t\t   , VM_MADP\r\n\t\t\t\t\t\t   WHERE DMMD_TEMP.CARRIER_ID = VM_MADP.CARRIER_ID\r\n\t\t\t\t\t\t   AND DMMD_TEMP.MBR_ID = VM_MADP.MBR_ID\r\n\t\t\t\t\t\t  \r\n                                                   AND DMMD_TEMP.CARRIER_ID in (${CARRIER_ID_LIST})\r\n\t\t\t\t\t\t   AND '${START_SUBMIT_DATE}' BETWEEN  DMMD_TEMP.MMD_FROM_DT  AND DMMD_TEMP.MMD_THRU_DT\r\n                                       ) DMD\r\n                   WHERE  DMD.RNUM = 1\r\n\t\t\t\t   ) ,\r\n\t\t\t\t   \r\nVM_DME AS\r\n(SELECT *\r\n                   FROM   (SELECT DME_TEMP.mbr_sk,\r\n\t\t\t\t  DME_TEMP.mbr_id,\r\n                                  DME_TEMP.cag_sk,\r\n                                  DME_TEMP.mel_eff_dt,\r\n                                  DME_TEMP.mel_thru_dt,\r\n                                  DME_TEMP.clt_prod_cd,\r\n                                  Row_number()\r\n                                    OVER (\r\n                                      partition BY DME_TEMP.carrier_id,\r\n\t\t\t\t\t\t\t\t  DME_TEMP.mbr_id\r\n                                      ORDER BY DME_TEMP.MEL_EFF_DT desc)\r\n                                  RNUM\r\n                      FROM   ${DB_RXCLAIM_DB_NAME}..d_member_eligibility DME_TEMP\r\n\t\t\t\t\t  \r\n                           WHERE   DME_TEMP.mel_stat_cd = 'A' AND\r\n                                   DME_TEMP.CARRIER_ID in (${CARRIER_ID_LIST})\r\n                               AND '${START_SUBMIT_DATE}'  BETWEEN  DME_TEMP.MEL_EFF_DT  AND DME_TEMP.MEL_THRU_DT\r\n                          ) MEL\r\n                   WHERE  MEL.rnum = 1)  \r\n\t\t\t\t   \r\nSELECT NVL(MADP_F.mbr_id  ,MADP_U.mbr_id )            AS MADP_MBR_ID,\r\n     NVL(MADP_F.carrier_id ,MADP_U.carrier_id)        AS MADP_CARRIER_ID,\r\n     MADP_F.MAD_ADJTMNT_DT           AS MADP_MAD_ADJTMNT_DT,\r\n     MADP_F.MAD_ADJTMNT_AMT_S        AS MADP_MAD_ADJTMNT_AMT_S,\r\n     MADP_F.MAD_ADJTMNT_AMT_T        AS MADP_MAD_ADJTMNT_AMT_T,\r\n     MADP_F.MTD_MAD_ADJTMNT_AMT_S    AS MADP_MTD_MAD_ADJTMNT_AMT_S,\r\n     MADP_F.MTD_MAD_ADJTMNT_AMT_T    AS MADP_MTD_MAD_ADJTMNT_AMT_T,\r\n     DMEM.MBR_SK                       AS DMEM_MBR_SK,\r\n     DMEM.ACCOUNT_ID                   AS DMEM_ACCOUNT_ID,\r\n     DMEM.CARRIER_ID                   AS DMEM_CARRIER_ID,\r\n     DMEM.EMPLOYER_GROUP_ID            AS DMEM_EMPLOYER_GROUP_ID,\r\n     DMEM.MB_FIRST_NM                  AS DMEM_MB_FIRST_NM,\r\n     DMEM.MB_LAST_NM                   AS DMEM_MB_LAST_NM,\r\n     DMEM.MB_MID_INIT_NM               AS DMEM_MB_MID_INIT_NM,\r\n     DMEM.MBR_ADDR1                    AS DMEM_MBR_ADDR1,\r\n     DMEM.MBR_ADDR2                    AS DMEM_MBR_ADDR2,\r\n     DMEM.MBR_ADDR3                    AS DMEM_MBR_ADDR3,\r\n     DMEM.MBR_CITY_NM                  AS DMEM_MBR_CITY_NM,\r\n     DMEM.MBR_ID                       AS DMEM_MBR_ID,\r\n     DMEM.MBR_LANG_CD                  AS DMEM_MBR_LANG_CD,\r\n     DMEM.MBR_ST_CD                    AS DMEM_MBR_ST_CD,\r\n     DMEM.MBR_ZIP                      AS DMEM_MBR_ZIP,\r\n     DMEM.MBR_ZIP2                     AS DMEM_MBR_ZIP2,\r\n     DMMD.MMD_COPAY_CATEGORY           AS DMMD_MMD_COPAY_CATEGORY,\r\n     DME.CLT_PROD_CD                   AS DME_CLT_PROD_CD, \r\n     MADP_U.YR_MAD_ADJTMNT_AMT_S       AS YR_MAD_ADJTMNT_AMT_S,\r\n     MADP_U.YR_MAD_ADJTMNT_AMT_T       AS YR_MAD_ADJTMNT_AMT_T\r\n\r\nFROM   VM_MADP MADP_F\r\n   FULL OUTER JOIN VM_MADP_ALL MADP_U\r\n   ON \t\t\tMADP_U.mbr_id = MADP_F.mbr_id\r\n               AND MADP_U.carrier_id = MADP_F.carrier_id\r\n\t   INNER JOIN ${DB_RXCLAIM_DB_NAME}..d_member dmem\r\n               ON   NVL( MADP_U.MBR_ID,MADP_F.MBR_ID ) = DMEM.mbr_id\r\n               AND   NVL( MADP_U.CARRIER_ID,MADP_F.CARRIER_ID ) = DMEM.carrier_id\r\n         AND NVL( MADP_U.CARRIER_ID,MADP_F.CARRIER_ID ) in (${CARRIER_ID_LIST})\r\n\t   LEFT JOIN VM_DME AS DME\r\n               ON DMEM.mbr_sk = DME.mbr_sk\r\n\r\n\t   LEFT JOIN VM_DMMD AS DMMD\r\n               ON DMMD.MBR_SK = DMEM.MBR_SK  ;
UNLOAD_FILE_NAME||||unload.madp_d_member.$RUN_ID.$UNLOAD_YEAR_MONTH.dat.gz
SQL_DML|f|||$AI_DML/eob/unload.madp_d_member.dml
SRT_KEY|$|||{dmem_carrier_id; dmem_mbr_id; dmem_mbr_sk}
RUN_ID||||20190302090003
UNLOAD_YEAR_MONTH||||201902
RXCLAIM_DBC|f|||$DB_RXCLAIM_DBC
