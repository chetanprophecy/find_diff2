/*Reformat operation*/

constant string("")RUN_MONTH parameter;

out::calculate_effective_dt(effective_dt,change_reason,run_month)=

begin
let string("") v_eff_dt_out_of_range;
let date("YYYYMMDD") v_next_year_start_dt;

v_next_year_start_dt= (date("YYYYMMDD"))string_lrtrim((decimal(""))string_concat(string_substring(run_month,1,4),"0101") + 10000);
v_eff_dt_out_of_range=if(string_lrtrim(change_reason) member [vector "AVLGENERIC","REQUIRESPA","QNTYLIMIT","STEPTHERPY","REQPAPTBD","GENBRNDT3"])
                                if((date("YYYYMMDD"))effective_dt > v_next_year_start_dt ) "Y" else "N"
                                
                           else if(string_lrtrim(change_reason) not member [vector "AVLGENERIC","REQUIRESPA","QNTYLIMIT","STEPTHERPY","REQPAPTBD","GENBRNDT3"])
                               "N" ;
                                
                                


out::if(is_null(effective_dt) or v_eff_dt_out_of_range=="Y") "" else effective_dt;

end;


out::calculate_formulary_change_code_id(change_reason,change_date,effective_dt,fmpd_sbm_dt,run_month,formulary_chg_cd_id)=
begin
let string("")in_period_form_flg;
let decimal("")v_cycle_prelim;
let string("")v_period_start_dt;
let string("")v_year_start_dt;
let date("YYYYMMDD")year_start_dt= (date("YYYYMMDD"))string_concat(string_substring(run_month,1,4),"0101");
let date("YYYYMMDD")period_start_dt = (date("YYYYMMDD"))string_concat(run_month,"01");
let date("YYYYMMDD")period_end_dt= (date("YYYYMMDD"))string_concat(run_month,(string(""))(decimal(""))date_month_end((decimal(""))string_substring(run_month,5,6)));
let decimal("")v_months_diff_change_period_start;
let decimal("")v_months_diff_change_effective;



v_period_start_dt = if(is_null(change_date))"" else if(is_valid((date("YYYYMMDD"))period_start_dt)) period_start_dt else "";

v_year_start_dt = if(is_null(change_date))"" else if(is_valid((date("YYYYMMDD"))year_start_dt)) year_start_dt else "";

v_months_diff_change_period_start= date_difference_months((date("YYYYMMDD"))change_date,period_start_dt);

v_months_diff_change_effective= date_difference_months((date("YYYYMMDD"))effective_dt,(date("YYYYMMDD"))change_date);

v_cycle_prelim= if(is_null(change_date))"" 
                else if(v_months_diff_change_period_start>1)"" 
                else if(v_months_diff_change_effective==0) switch(v_months_diff_change_period_start)
                                                            case 1:1;
                                                            default:"";
                                                          end
                                                          
                else if(v_months_diff_change_effective==1) switch(v_months_diff_change_period_start)
                                                            case 1:1;
                                                            case 0:2;
                                                            default:"";
                                                          end
                                                          
                else if(v_months_diff_change_effective==2) switch(v_months_diff_change_period_start)
                                                            case 1:1;
                                                            case 0:2;
                                                            case -1:3;
                                                            default:"";
                                                          end
                                                          
                                                          
                else if(v_months_diff_change_effective==3) switch(v_months_diff_change_period_start)
                                                            case 1:1;
                                                            case 0:2;
                                                            case -1:3;
                                                            case -2:4;
                                                            default:"";
                                                          end
                 
                 
                 else if(v_months_diff_change_effective==4) switch(v_months_diff_change_period_start)
                                                            case 1:1;
                                                            case 0:2;
                                                            case -1:3;
                                                            case -2:4;
                                                            case -3:5;
                                                            default:"";
                                                          end
                                                          
                                                          
                  else if(v_months_diff_change_effective==5) switch(v_months_diff_change_period_start)
                                                            case 1:1;
                                                            case 0:2;
                                                            case -1:3;
                                                            case -2:4;
                                                            case -3:5;
                                                            case -4:6;
                                                            default:"";
                                                          end
                                                          
                                                          
                 else if(v_months_diff_change_effective==6) switch(v_months_diff_change_period_start)
                                                            case 1:1;
                                                            case 0:2;
                                                            case -1:3;
                                                            case -2:4;
                                                            case -3:5;
                                                            case -4:6;
                                                            case -5:7;
                                                            default:"";
                                                          end
                                                          
                                                          
                 else if(v_months_diff_change_effective==7) switch(v_months_diff_change_period_start)
                                                            case 1:1;
                                                            case 0:2;
                                                            case -1:3;
                                                            case -2:4;
                                                            case -3:5;
                                                            case -4:6;
                                                            case -5:7;
                                                            case -6:8;
                                                            default:"";
                                                          end
                                                          
                                                          
                                                          
                 else if(v_months_diff_change_effective==8) switch(v_months_diff_change_period_start)
                                                            case 1:1;
                                                            case 0:2;
                                                            case -1:3;
                                                            case -2:4;
                                                            case -3:5;
                                                            case -4:6;
                                                            case -5:7;
                                                            case -6:8;
                                                            default:"";
                                                          end
                  
                  
                 else if(v_months_diff_change_effective==8) switch(v_months_diff_change_period_start)
                                                            case 1:1;
                                                            case 0:2;
                                                            case -1:3;
                                                            case -2:4;
                                                            case -3:5;
                                                            case -4:6;
                                                            case -5:7;
                                                            case -6:8;
                                                            case -7:9;
                                                            default:"";
                                                          end  
                                                          
                                                          
                 else if(v_months_diff_change_effective==9) switch(v_months_diff_change_period_start)
                                                            case 1:1;
                                                            case 0:2;
                                                            case -1:3;
                                                            case -2:4;
                                                            case -3:5;
                                                            case -4:6;
                                                            case -5:7;
                                                            case -6:8;
                                                            case -7:9;
                                                            case -8:10;
                                                            default:"";
                                                          end                                    
                                                         
                                                          
                 else "";
                                                      

in_period_form_flg= if(string_lrtrim(change_reason) member[vector "AVLGENERIC","REQUIRESPA","QNTYLIMIT","STEPTHERPY","REQPAPTBD","GENBRNDT3"])
                           if(v_cycle_prelim==1)
                                if(fmpd_sbm_dt <= period_end_dt and fmpd_sbm_dt >= ((decimal(""))date_difference_days((date("YYYYMMDD"))date_add_months((date("YYYYMMDD"))v_period_start_dt,-2),(date("YYYYMMDD"))v_year_start_dt)<0)? year_start_dt:year_start_dt)"Y"
                                else ""
                            
                             
                           else if(v_cycle_prelim member[vector 2,3,4,5,6,7,8,9]) (((date("YYYYMMDD"))fmpd_sbm_dt <= period_end_dt and (date("YYYYMMDD"))fmpd_sbm_dt >= period_start_dt)?"Y":"")
                                else ""
                                   
                     else if(v_months_diff_change_period_start ==1)"Y"  
                          else "";



                       
out::if(in_period_form_flg=="Y")formulary_chg_cd_id else "" ;
end;



out::reformat(in)=
begin

let d_product_lkp_rec   = lookup("d_product_lkp", in.fmpd_prod_sk) ;
let d_contract_pbp_extn_lkp_rec = lookup("d_contract_pbp_extn_lkp",in.fmpd_contract_pbp_sk);
let formulary_lkp_rec  = lookup("l_eob_formulary_lkp",d_contract_pbp_extn_lkp_rec.pdp_frmlry_notice_list,d_product_lkp_rec.prod_id);




  out.dmem_mbr_sk                                       :: in.dmem_mbr_sk;
  out.filename                                          :: in.filename;
  out.print_file.record_identifier                      :: "FD";
  out.print_file.formulary.*                                :: "";
  out.print_file.formulary.carrier_id                       :: in.dmem_carrier_id;
  out.print_file.formulary.account_id                       :: in.dmem_account_id;
  out.print_file.formulary.group_id                         :: in.dmem_employer_group_id;
  out.print_file.formulary.member_id                        :: in.dmem_mbr_id; 
  out.print_file.formulary.type_of_change                   :: "";
  //out.print_file.formulary.affected_drug                    :: string_concat(string_upcase(string_substring(formulary_lkp_rec.drg_nm,1,1)),string_substring(formulary_lkp_rec.drg_nm,2,length_of(formulary_lkp_rec.drg_nm)));
  out.print_file.formulary.affected_drug                    :: string_join(for(let i in string_split_no_empty(first_defined(formulary_lkp_rec.drg_nm,"")," ")):
                                                                        string_concat(
                                                                                string_upcase(string_substring(i,1,1))
                                                                                ,
                                                                                first_defined(string_downcase(string_substring(i,2,(string_length(i)-1))),"")
                                                                                )," ");
//  out.print_file.formulary.description_of_change            :: "";
  out.print_file.formulary.description_of_change            :: first_defined(formulary_lkp_rec.chg_cd_desc,"");
//  out.print_file.formulary.reason_for_change                :: formulary_lkp_rec.chg_reason;
  out.print_file.formulary.reason_for_change                :: first_defined(formulary_lkp_rec.chg_reason_desc,"");
  out.print_file.formulary.alternative_drug                 :: if(is_null(formulary_lkp_rec.alt_drg_nm)) " " else string_concat(string_upcase(string_substring(formulary_lkp_rec.alt_drg_nm,1,1)),string_substring(formulary_lkp_rec.alt_drg_nm,2,length_of(formulary_lkp_rec.alt_drg_nm)));
  out.print_file.formulary.alternative_drug_copayment_coinsurance :: first_defined(formulary_lkp_rec.tier_cd,"");
  out.print_file.formulary.effective_date :: calculate_effective_dt(formulary_lkp_rec.effective_dt,formulary_lkp_rec.chg_reason,RUN_MONTH);
  out.print_file.formulary.variable_text_drug_name_in_the_event_of_change_to_preferred_or_tiered_cost_sharing_stauts :: "";
  out.print_file.formulary.data_trigger_to_identify_negative_change_identifier_asterisk_at_print_vendor :: "";
  out.print_file.formulary.data_trigger_to_identify_prior_authorization_statement_per_cms_model :: "";
  out.print_file.formulary.data_trigger_to_identify_quantity_limits_statement_and_variable_drug_name_per_cms_model :: "";
  out.print_file.formulary.data_trigger_to_identify_step_therapy_statement_per_cms_model :: "";
  out.print_file.formulary.formulary_change_code_id :: calculate_formulary_change_code_id(formulary_lkp_rec.chg_reason,formulary_lkp_rec.chg_dt,formulary_lkp_rec.effective_dt,in.fmpd_sbm_dt,RUN_MONTH,formulary_lkp_rec.formulary_chg_cd_id);
//  out.print_file.formulary.formulary_change_code_id :: "";
  out.print_file.formulary.affected_drug_current_tier :: first_defined(formulary_lkp_rec.affected_drg_current_tier_ind,"");
  out.print_file.formulary.affected_drug_new_tier :: first_defined(formulary_lkp_rec.affected_drg_new_tier_ind,"");
  out.print_file.formulary.quantity_limits_description :: first_defined(formulary_lkp_rec.qty_limit_desc,"");
  out.print_file.formulary.manufacturer_name :: first_defined(formulary_lkp_rec.manufacturer_nm,"");
  out.print_file.formulary.filler :: "";
//  out.print_file.formulary.newline :: "\r\n";
  out.print_file.hdr.*::"";
  out.print_file.bonus.*::"";
  out.print_file.claim.*::"";
  out.print_file.trailer.*::"";
  out.print_file.plan.*::"";
  out.print_file.mbr.* ::"";
  out.carrier_id :: in.dmem_carrier_id;
  out.mbr_id :: in.dmem_mbr_id;
  end;
