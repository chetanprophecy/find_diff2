CREATE OR REPLACE VIEW ADMIN.V_A_MPF_MON_RPT_SUM_PF AS SELECT INT8(("VARCHAR"(A.RPT_MON) || "VARCHAR"(ROW_NUMBER() OVER ( ORDER BY NULL::UNKNOWN )))) AS MPF_MON_SUM_SK, A.RPT_MON, A.CAG_SK, A.PDE_CONTRACT_ID, A.PDE_REC_ID, A.PHR_RETAIL_FLG, A.PDE_DRUG_COV_CD, A.MEDCR_PLAN_TYPE_CD, A.CLAIM_STAT_CD, A.PHR_SRVC_TYPE_CD, A.DISCREPENCY_TYPE, A.DISCREPANCY_GTE_0050, A.DISCREPANCY_LTE_0050, A.DISCREPANCY_GT_LT_0050, A.DISCREPANCY_GTE_LTE_0050, A.DISCREPANCY_GTE01_LTE005, A.DISCREPANCY_GTE005_LTE01, A.PDE_BRAND_GENRIC_CD, A.PHR_COST_TYPE, A.PDE_PROD_ID, A.PROXY_NDC_FLG, A.MAPPED_NDC_FLG, A.PC_FILE_PST_CD_FLG, A.PDE_DAY_OF_SPPL_CATGY, A.PDE_CLAIM_NBR_CNT, A.EST_MPF_COST_TOT, A.EST_PDE_COST_TOT, A.EST_DISCREPANCY_TOT, A.PDE_DRUG_QTY_SUM, A.SRC_ENV_SK, A.INSERT_TS, A.UPDATE_TS, A.INSERT_UID, A.UPDATE_UID, A.RUN_ID, A.REC_STAT_CD, A.PDE_ADJ_DEL_CD FROM ((SELECT INT4(TO_CHAR("TIMESTAMP"(PDE_RECENT.PDE_FILLED_DT), 'YYYYMM'::"VARCHAR")) AS RPT_MON, PDE_RECENT.CAG_SK, PDE_RECENT.PDE_CONTRACT_ID, PDE_RECENT.PDE_RECORD_ID AS PDE_REC_ID, PDE_RECENT.PHR_RETAIL_FLG, PDE_RECENT.PDE_DRG_CVG_CD AS PDE_DRUG_COV_CD, CONTRACT_PBP_HIST.MEDICARE_PLAN_TYPE_CD AS MEDCR_PLAN_TYPE_CD, PDE_RECENT.PDE_CLAIM_STAT_ID AS CLAIM_STAT_CD, PDE_RECENT.PDE_PHR_SVC_TYP AS PHR_SRVC_TYPE_CD, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY > '-0.005'::NUMERIC(3,3)) AND (PDE_RECENT.TOT_EST_DISCREPANCY < '0.005'::NUMERIC(3,3))) THEN 'No Discrepancy'::"VARCHAR" WHEN ((CASE WHEN ((PDE_RECENT.PDE_DISPENSING_FEE - PDE_RECENT.MPF_DISPENSING_FEE) = '0'::NUMERIC) THEN NULL::"NUMERIC" ELSE (PDE_RECENT.PDE_DISPENSING_FEE - PDE_RECENT.MPF_DISPENSING_FEE) END / CASE WHEN (PDE_RECENT.TOT_EST_DISCREPANCY = '0'::NUMERIC) THEN NULL::"NUMERIC" ELSE PDE_RECENT.TOT_EST_DISCREPANCY END) > '0.5'::NUMERIC(1,1)) THEN 'Dispensing Fee'::"VARCHAR" WHEN (((PDE_RECENT.TOT_EST_DISCREPANCY >= '-0.01'::NUMERIC(2,2)) AND (PDE_RECENT.TOT_EST_DISCREPANCY <= '-0.005'::NUMERIC(3,3))) OR ((PDE_RECENT.TOT_EST_DISCREPANCY <= '0.01'::NUMERIC(2,2)) AND (PDE_RECENT.TOT_EST_DISCREPANCY >= '0.005'::NUMERIC(3,3)))) THEN 'Rounding Error'::"VARCHAR" WHEN (CASE WHEN (DD.RANK1 = 4) THEN DD.UNIT_COST ELSE '0'::NUMERIC END = '0'::NUMERIC) THEN 'Indeterminate'::"VARCHAR" WHEN ((ROUND(PDE_RECENT.MPF_NDC_UNIT_COST, 3) = ROUND(CASE WHEN (DD.RANK1 = 4) THEN DD.UNIT_COST ELSE '0'::NUMERIC END, 3)) AND (ROUND(PDE_RECENT.MPF_NDC_UNIT_COST, 3) <> ROUND(PDE_RECENT.PDE_NDC_UNIT_COST, 3))) THEN 'Proxy Issue'::"VARCHAR" WHEN ((ROUND(PDE_RECENT.MPF_NDC_UNIT_COST, 3) <> ROUND(CASE WHEN (DD.RANK1 = 4) THEN DD.UNIT_COST ELSE '0'::NUMERIC END, 3)) AND (ROUND(CASE WHEN (DD.RANK1 = 4) THEN DD.UNIT_COST ELSE '0'::NUMERIC END, 3) = ROUND(PDE_RECENT.PDE_NDC_UNIT_COST, 3))) THEN 'Timing Issue'::"VARCHAR" ELSE 'Other'::"VARCHAR" END AS DISCREPENCY_TYPE, CASE WHEN (PDE_RECENT.TOT_EST_DISCREPANCY >= '0.005'::NUMERIC(3,3)) THEN 1 ELSE 0 END AS DISCREPANCY_GTE_0050, CASE WHEN (PDE_RECENT.TOT_EST_DISCREPANCY <= '-0.005'::NUMERIC(3,3)) THEN 1 ELSE 0 END AS DISCREPANCY_LTE_0050, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY > '-0.005'::NUMERIC(3,3)) AND (PDE_RECENT.TOT_EST_DISCREPANCY < '0.005'::NUMERIC(3,3))) THEN 1 ELSE 0 END AS DISCREPANCY_GT_LT_0050, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY >= '-0.005'::NUMERIC(3,3)) AND (PDE_RECENT.TOT_EST_DISCREPANCY <= '0.005'::NUMERIC(3,3))) THEN 1 ELSE 0 END AS DISCREPANCY_GTE_LTE_0050, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY >= '-0.01'::NUMERIC(2,2)) AND (PDE_RECENT.TOT_EST_DISCREPANCY <= '-0.005'::NUMERIC(3,3))) THEN 1 ELSE 0 END AS DISCREPANCY_GTE01_LTE005, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY <= '0.01'::NUMERIC(2,2)) AND (PDE_RECENT.TOT_EST_DISCREPANCY >= '0.005'::NUMERIC(3,3))) THEN 1 ELSE 0 END AS DISCREPANCY_GTE005_LTE01, PDE_RECENT.PDE_BRAND_GENERIC_CD AS PDE_BRAND_GENRIC_CD, PDE_RECENT.PHR_COST_TYPE, PDE_RECENT.PDE_PROD_ID, CASE WHEN (PDE_RECENT.PDE_PROD_ID = PDE_RECENT.PDE_PROXY_PROD_ID) THEN 1 ELSE 0 END AS PROXY_NDC_FLG, CASE WHEN (PDE_RECENT.PDE_PROD_ID <> PDE_RECENT.PDE_PROXY_PROD_ID) THEN 1 ELSE 0 END AS MAPPED_NDC_FLG, CASE WHEN ((((((PDE_RECENT.PDE_PHR_SVC_TYP = '01'::"VARCHAR") OR (PDE_RECENT.PDE_PHR_SVC_TYP = '07'::"VARCHAR")) AND (PDE_RECENT.PHR_RETAIL_FLG = '1'::BPCHAR)) AND (PDE_RECENT.PHR_LTC_FLG = '0'::BPCHAR)) AND (PDE_RECENT.PHR_HI_FLG = '0'::BPCHAR)) AND (PDE_RECENT.PHR_MAIL_FLG = '0'::BPCHAR)) THEN 'B'::"VARCHAR" WHEN ((((PDE_RECENT.PHR_RETAIL_FLG = '1'::BPCHAR) AND (PDE_RECENT.PHR_LTC_FLG = '0'::BPCHAR)) AND (PDE_RECENT.PHR_HI_FLG = '0'::BPCHAR)) AND (PDE_RECENT.PHR_MAIL_FLG = '0'::BPCHAR)) THEN 'F'::"VARCHAR" WHEN ((PDE_RECENT.PDE_PHR_SVC_TYP = '01'::"VARCHAR") OR (PDE_RECENT.PDE_PHR_SVC_TYP = '07'::"VARCHAR")) THEN 'C'::"VARCHAR" ELSE 'N'::"VARCHAR" END AS PC_FILE_PST_CD_FLG, CASE WHEN ((PDE_RECENT.PDE_DAYS_OF_SUPPLY >= 28) AND (PDE_RECENT.PDE_DAYS_OF_SUPPLY <= 34)) THEN '28-34'::"VARCHAR" WHEN ((PDE_RECENT.PDE_DAYS_OF_SUPPLY >= 60) AND (PDE_RECENT.PDE_DAYS_OF_SUPPLY <= 62)) THEN '60-62'::"VARCHAR" WHEN ((PDE_RECENT.PDE_DAYS_OF_SUPPLY >= 90) AND (PDE_RECENT.PDE_DAYS_OF_SUPPLY <= 93)) THEN '90-93'::"VARCHAR" ELSE 'OTH'::"VARCHAR" END AS PDE_DAY_OF_SPPL_CATGY, COUNT(PDE_RECENT.PDE_CLAIM_NBR) AS PDE_CLAIM_NBR_CNT, SUM(PDE_RECENT.TOT_EST_MPF_COST) AS EST_MPF_COST_TOT, SUM(PDE_RECENT.TOT_EST_PDE_COST) AS EST_PDE_COST_TOT, SUM(PDE_RECENT.TOT_EST_DISCREPANCY) AS EST_DISCREPANCY_TOT, SUM(PDE_RECENT.PDE_DRG_QTY) AS PDE_DRUG_QTY_SUM, PDE_RECENT.SRC_ENV_SK, "TIMESTAMP"('now(0)'::"VARCHAR") AS INSERT_TS, "TIMESTAMP"('now(0)'::"VARCHAR") AS UPDATE_TS, 'APP_ORX_ETL_PRD'::"VARCHAR" AS INSERT_UID, 'APP_ORX_ETL_PRD'::"VARCHAR" AS UPDATE_UID, "NUMERIC"(TO_CHAR("TIMESTAMP"('now(0)'::"VARCHAR"), 'YYYYMMDDHH24MISS'::"VARCHAR"), 917516) AS RUN_ID, 1 AS REC_STAT_CD, PDE_RECENT.PDE_ADJ_DEL_CD FROM ((ADMIN.V_F_MPD_PDE_RECENT_MPF PDE_RECENT JOIN ORX_IDW_DM_PRD.ADMIN.D_CARRIER_CONTRACT_PBP_HIST CONTRACT_PBP_HIST ON ((((((CONTRACT_PBP_HIST.CONTRACT_ID = PDE_RECENT.PDE_CONTRACT_ID) AND (CONTRACT_PBP_HIST.PBP_ID = PDE_RECENT.PDE_PBP_ID)) AND (CONTRACT_PBP_HIST.BENEFIT_YR = SQLEXTDB.ADMIN."YEAR"(PDE_RECENT.PDE_FILLED_DT))) AND (CONTRACT_PBP_HIST.CARRIER_ID = PDE_RECENT.PDE_CARRIER_ID)) AND (CONTRACT_PBP_HIST.SRC_ENV_SK = PDE_RECENT.SRC_ENV_SK)))) LEFT JOIN (SELECT DIM.PDE_CONTRACT_ID, DIM.DIM_DIRECTORY_DT, DIM.UNIT_COST, DIM.RANK1, DIM.PDE_CLAIM_NBR FROM (SELECT RECENT.PDE_FILLED_DT, RECENT.PDE_CONTRACT_ID, RECENT.PROD_DIRECTORY_DT AS FF_DIRECTORY_DT, PF_FILE.PROD_DIRECTORY_DT AS DIM_DIRECTORY_DT, PF_FILE.UNIT_COST, PF_FILE.CMS_CONTRACT_ID, PF_FILE.DAYS_OF_SUPPLY, PF_FILE.CMS_PROXY_NDC_ID, PF_FILE.PRICE_ID, RECENT.PDE_CLAIM_NBR, DENSE_RANK() OVER (PARTITION BY PF_FILE.CMS_CONTRACT_ID, PF_FILE.DAYS_OF_SUPPLY, PF_FILE.CMS_PROXY_NDC_ID, PF_FILE.PRICE_ID  ORDER BY PF_FILE.PROD_DIRECTORY_DT ) AS RANK1 FROM (ADMIN.V_F_MPD_PDE_RECENT_MPF RECENT LEFT JOIN ORX_IDW_DM_PRD.ADMIN.D_CMS_DRUG_PRICING_FILE PF_FILE ON ((((((RECENT.PDE_CONTRACT_ID = PF_FILE.CMS_CONTRACT_ID) AND (RECENT.PDE_DAYS_OF_SUPPLY = PF_FILE.DAYS_OF_SUPPLY)) AND (RECENT.PRICE_ID = PF_FILE.PRICE_ID)) AND (RECENT.PDE_PROXY_PROD_ID = PF_FILE.CMS_PROXY_NDC_ID)) AND (RECENT.PRICING_FILE_MAIL_FLG = PF_FILE.PRICING_FILE_MAIL_FLG)))) WHERE (PF_FILE.PROD_DIRECTORY_DT >= RECENT.PROD_DIRECTORY_DT)) DIM WHERE (DIM.RANK1 = 4)) DD ON (((DD.PDE_CONTRACT_ID = PDE_RECENT.PDE_CONTRACT_ID) AND (DD.PDE_CLAIM_NBR = PDE_RECENT.PDE_CLAIM_NBR)))) WHERE ((((PDE_RECENT.PDE_DRG_CVG_CD = 'C'::BPCHAR) AND (CONTRACT_PBP_HIST.CPB_STATUS_CD = 'A'::BPCHAR)) AND (NOT ((PDE_RECENT.PDE_PROXY_PROD_ID = '-'::"VARCHAR") OR (PDE_RECENT.PRICE_ID = '-'::"VARCHAR") OR (PDE_RECENT.MPF_NDC_UNIT_COST = '0'::NUMERIC)))) AND (NOT (INT4((PDE_RECENT.PDE_COMPOUND_CD)::"VARCHAR") > 1))) GROUP BY INT4(TO_CHAR("TIMESTAMP"(PDE_RECENT.PDE_FILLED_DT), 'YYYYMM'::"VARCHAR")), PDE_RECENT.CAG_SK, PDE_RECENT.PDE_CONTRACT_ID, PDE_RECENT.PDE_RECORD_ID, PDE_RECENT.PHR_RETAIL_FLG, PDE_RECENT.PDE_DRG_CVG_CD, CONTRACT_PBP_HIST.MEDICARE_PLAN_TYPE_CD, PDE_RECENT.PDE_CLAIM_STAT_ID, PDE_RECENT.PDE_PHR_SVC_TYP, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY > '-0.005'::NUMERIC(3,3)) AND (PDE_RECENT.TOT_EST_DISCREPANCY < '0.005'::NUMERIC(3,3))) THEN 'No Discrepancy'::"VARCHAR" WHEN ((CASE WHEN ((PDE_RECENT.PDE_DISPENSING_FEE - PDE_RECENT.MPF_DISPENSING_FEE) = '0'::NUMERIC) THEN NULL::"NUMERIC" ELSE (PDE_RECENT.PDE_DISPENSING_FEE - PDE_RECENT.MPF_DISPENSING_FEE) END / CASE WHEN (PDE_RECENT.TOT_EST_DISCREPANCY = '0'::NUMERIC) THEN NULL::"NUMERIC" ELSE PDE_RECENT.TOT_EST_DISCREPANCY END) > '0.5'::NUMERIC(1,1)) THEN 'Dispensing Fee'::"VARCHAR" WHEN (((PDE_RECENT.TOT_EST_DISCREPANCY >= '-0.01'::NUMERIC(2,2)) AND (PDE_RECENT.TOT_EST_DISCREPANCY <= '-0.005'::NUMERIC(3,3))) OR ((PDE_RECENT.TOT_EST_DISCREPANCY <= '0.01'::NUMERIC(2,2)) AND (PDE_RECENT.TOT_EST_DISCREPANCY >= '0.005'::NUMERIC(3,3)))) THEN 'Rounding Error'::"VARCHAR" WHEN (CASE WHEN (DD.RANK1 = 4) THEN DD.UNIT_COST ELSE '0'::NUMERIC END = '0'::NUMERIC) THEN 'Indeterminate'::"VARCHAR" WHEN ((ROUND(PDE_RECENT.MPF_NDC_UNIT_COST, 3) = ROUND(CASE WHEN (DD.RANK1 = 4) THEN DD.UNIT_COST ELSE '0'::NUMERIC END, 3)) AND (ROUND(PDE_RECENT.MPF_NDC_UNIT_COST, 3) <> ROUND(PDE_RECENT.PDE_NDC_UNIT_COST, 3))) THEN 'Proxy Issue'::"VARCHAR" WHEN ((ROUND(PDE_RECENT.MPF_NDC_UNIT_COST, 3) <> ROUND(CASE WHEN (DD.RANK1 = 4) THEN DD.UNIT_COST ELSE '0'::NUMERIC END, 3)) AND (ROUND(CASE WHEN (DD.RANK1 = 4) THEN DD.UNIT_COST ELSE '0'::NUMERIC END, 3) = ROUND(PDE_RECENT.PDE_NDC_UNIT_COST, 3))) THEN 'Timing Issue'::"VARCHAR" ELSE 'Other'::"VARCHAR" END, CASE WHEN (PDE_RECENT.TOT_EST_DISCREPANCY >= '0.005'::NUMERIC(3,3)) THEN 1 ELSE 0 END, CASE WHEN (PDE_RECENT.TOT_EST_DISCREPANCY <= '-0.005'::NUMERIC(3,3)) THEN 1 ELSE 0 END, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY > '-0.005'::NUMERIC(3,3)) AND (PDE_RECENT.TOT_EST_DISCREPANCY < '0.005'::NUMERIC(3,3))) THEN 1 ELSE 0 END, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY >= '-0.005'::NUMERIC(3,3)) AND (PDE_RECENT.TOT_EST_DISCREPANCY <= '0.005'::NUMERIC(3,3))) THEN 1 ELSE 0 END, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY >= '-0.01'::NUMERIC(2,2)) AND (PDE_RECENT.TOT_EST_DISCREPANCY <= '-0.005'::NUMERIC(3,3))) THEN 1 ELSE 0 END, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY <= '0.01'::NUMERIC(2,2)) AND (PDE_RECENT.TOT_EST_DISCREPANCY >= '0.005'::NUMERIC(3,3))) THEN 1 ELSE 0 END, PDE_RECENT.PDE_BRAND_GENERIC_CD, PDE_RECENT.PHR_COST_TYPE, PDE_RECENT.PDE_PROD_ID, CASE WHEN (PDE_RECENT.PDE_PROD_ID = PDE_RECENT.PDE_PROXY_PROD_ID) THEN 1 ELSE 0 END, CASE WHEN (PDE_RECENT.PDE_PROD_ID <> PDE_RECENT.PDE_PROXY_PROD_ID) THEN 1 ELSE 0 END, CASE WHEN ((((((PDE_RECENT.PDE_PHR_SVC_TYP = '01'::"VARCHAR") OR (PDE_RECENT.PDE_PHR_SVC_TYP = '07'::"VARCHAR")) AND (PDE_RECENT.PHR_RETAIL_FLG = '1'::BPCHAR)) AND (PDE_RECENT.PHR_LTC_FLG = '0'::BPCHAR)) AND (PDE_RECENT.PHR_HI_FLG = '0'::BPCHAR)) AND (PDE_RECENT.PHR_MAIL_FLG = '0'::BPCHAR)) THEN 'B'::"VARCHAR" WHEN ((((PDE_RECENT.PHR_RETAIL_FLG = '1'::BPCHAR) AND (PDE_RECENT.PHR_LTC_FLG = '0'::BPCHAR)) AND (PDE_RECENT.PHR_HI_FLG = '0'::BPCHAR)) AND (PDE_RECENT.PHR_MAIL_FLG = '0'::BPCHAR)) THEN 'F'::"VARCHAR" WHEN ((PDE_RECENT.PDE_PHR_SVC_TYP = '01'::"VARCHAR") OR (PDE_RECENT.PDE_PHR_SVC_TYP = '07'::"VARCHAR")) THEN 'C'::"VARCHAR" ELSE 'N'::"VARCHAR" END, CASE WHEN ((PDE_RECENT.PDE_DAYS_OF_SUPPLY >= 28) AND (PDE_RECENT.PDE_DAYS_OF_SUPPLY <= 34)) THEN '28-34'::"VARCHAR" WHEN ((PDE_RECENT.PDE_DAYS_OF_SUPPLY >= 60) AND (PDE_RECENT.PDE_DAYS_OF_SUPPLY <= 62)) THEN '60-62'::"VARCHAR" WHEN ((PDE_RECENT.PDE_DAYS_OF_SUPPLY >= 90) AND (PDE_RECENT.PDE_DAYS_OF_SUPPLY <= 93)) THEN '90-93'::"VARCHAR" ELSE 'OTH'::"VARCHAR" END, PDE_RECENT.SRC_ENV_SK, PDE_RECENT.PDE_ADJ_DEL_CD) UNION ALL (SELECT INT4(TO_CHAR("TIMESTAMP"(PDE_RECENT.PDE_FILLED_DT), 'YYYYMM'::"VARCHAR")) AS RPT_MON, PDE_RECENT.CAG_SK, PDE_RECENT.PDE_CONTRACT_ID, PDE_RECENT.PDE_RECORD_ID AS PDE_REC_ID, PDE_RECENT.PHR_RETAIL_FLG, PDE_RECENT.PDE_DRG_CVG_CD AS PDE_DRUG_COV_CD, CONTRACT_PBP_HIST.MEDICARE_PLAN_TYPE_CD AS MEDCR_PLAN_TYPE_CD, PDE_RECENT.PDE_CLAIM_STAT_ID AS CLAIM_STAT_CD, PDE_RECENT.PDE_PHR_SVC_TYP AS PHR_SRVC_TYPE_CD, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY > '-0.005'::NUMERIC(3,3)) AND (PDE_RECENT.TOT_EST_DISCREPANCY < '0.005'::NUMERIC(3,3))) THEN 'No Discrepancy'::"VARCHAR" WHEN ((CASE WHEN ((PDE_RECENT.PDE_DISPENSING_FEE - PDE_RECENT.MPF_DISPENSING_FEE) = '0'::NUMERIC) THEN NULL::"NUMERIC" ELSE (PDE_RECENT.PDE_DISPENSING_FEE - PDE_RECENT.MPF_DISPENSING_FEE) END / CASE WHEN (PDE_RECENT.TOT_EST_DISCREPANCY = '0'::NUMERIC) THEN NULL::"NUMERIC" ELSE PDE_RECENT.TOT_EST_DISCREPANCY END) > '0.5'::NUMERIC(1,1)) THEN 'Dispensing Fee'::"VARCHAR" WHEN (((PDE_RECENT.TOT_EST_DISCREPANCY >= '-0.01'::NUMERIC(2,2)) AND (PDE_RECENT.TOT_EST_DISCREPANCY <= '-0.005'::NUMERIC(3,3))) OR ((PDE_RECENT.TOT_EST_DISCREPANCY <= '0.01'::NUMERIC(2,2)) AND (PDE_RECENT.TOT_EST_DISCREPANCY >= '0.005'::NUMERIC(3,3)))) THEN 'Rounding Error'::"VARCHAR" WHEN (CASE WHEN (DD.RANK1 = 4) THEN DD.UNIT_COST ELSE '0'::NUMERIC END = '0'::NUMERIC) THEN 'Indeterminate'::"VARCHAR" WHEN ((ROUND(PDE_RECENT.MPF_NDC_UNIT_COST, 3) = ROUND(CASE WHEN (DD.RANK1 = 4) THEN DD.UNIT_COST ELSE '0'::NUMERIC END, 3)) AND (ROUND(PDE_RECENT.MPF_NDC_UNIT_COST, 3) <> ROUND(PDE_RECENT.PDE_NDC_UNIT_COST, 3))) THEN 'Proxy Issue'::"VARCHAR" WHEN ((ROUND(PDE_RECENT.MPF_NDC_UNIT_COST, 3) <> ROUND(CASE WHEN (DD.RANK1 = 4) THEN DD.UNIT_COST ELSE '0'::NUMERIC END, 3)) AND (ROUND(CASE WHEN (DD.RANK1 = 4) THEN DD.UNIT_COST ELSE '0'::NUMERIC END, 3) = ROUND(PDE_RECENT.PDE_NDC_UNIT_COST, 3))) THEN 'Timing Issue'::"VARCHAR" ELSE 'Other'::"VARCHAR" END AS DISCREPENCY_TYPE, CASE WHEN (PDE_RECENT.TOT_EST_DISCREPANCY >= '0.005'::NUMERIC(3,3)) THEN 1 ELSE 0 END AS DISCREPANCY_GTE_0050, CASE WHEN (PDE_RECENT.TOT_EST_DISCREPANCY <= '-0.005'::NUMERIC(3,3)) THEN 1 ELSE 0 END AS DISCREPANCY_LTE_0050, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY > '-0.005'::NUMERIC(3,3)) AND (PDE_RECENT.TOT_EST_DISCREPANCY < '0.005'::NUMERIC(3,3))) THEN 1 ELSE 0 END AS DISCREPANCY_GT_LT_0050, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY >= '-0.005'::NUMERIC(3,3)) AND (PDE_RECENT.TOT_EST_DISCREPANCY <= '0.005'::NUMERIC(3,3))) THEN 1 ELSE 0 END AS DISCREPANCY_GTE_LTE_0050, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY >= '-0.01'::NUMERIC(2,2)) AND (PDE_RECENT.TOT_EST_DISCREPANCY <= '-0.005'::NUMERIC(3,3))) THEN 1 ELSE 0 END AS DISCREPANCY_GTE01_LTE005, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY <= '0.01'::NUMERIC(2,2)) AND (PDE_RECENT.TOT_EST_DISCREPANCY >= '0.005'::NUMERIC(3,3))) THEN 1 ELSE 0 END AS DISCREPANCY_GTE005_LTE01, PDE_RECENT.PDE_BRAND_GENERIC_CD AS PDE_BRAND_GENRIC_CD, PDE_RECENT.PHR_COST_TYPE, PDE_RECENT.PDE_PROD_ID, CASE WHEN (PDE_RECENT.PDE_PROD_ID = PDE_RECENT.PDE_PROXY_PROD_ID) THEN 1 ELSE 0 END AS PROXY_NDC_FLG, CASE WHEN (PDE_RECENT.PDE_PROD_ID <> PDE_RECENT.PDE_PROXY_PROD_ID) THEN 1 ELSE 0 END AS MAPPED_NDC_FLG, CASE WHEN ((((((PDE_RECENT.PDE_PHR_SVC_TYP = '01'::"VARCHAR") OR (PDE_RECENT.PDE_PHR_SVC_TYP = '07'::"VARCHAR")) AND (PDE_RECENT.PHR_RETAIL_FLG = '1'::BPCHAR)) AND (PDE_RECENT.PHR_LTC_FLG = '0'::BPCHAR)) AND (PDE_RECENT.PHR_HI_FLG = '0'::BPCHAR)) AND (PDE_RECENT.PHR_MAIL_FLG = '0'::BPCHAR)) THEN 'B'::"VARCHAR" WHEN ((((PDE_RECENT.PHR_RETAIL_FLG = '1'::BPCHAR) AND (PDE_RECENT.PHR_LTC_FLG = '0'::BPCHAR)) AND (PDE_RECENT.PHR_HI_FLG = '0'::BPCHAR)) AND (PDE_RECENT.PHR_MAIL_FLG = '0'::BPCHAR)) THEN 'F'::"VARCHAR" WHEN ((PDE_RECENT.PDE_PHR_SVC_TYP = '01'::"VARCHAR") OR (PDE_RECENT.PDE_PHR_SVC_TYP = '07'::"VARCHAR")) THEN 'C'::"VARCHAR" ELSE 'N'::"VARCHAR" END AS PC_FILE_PST_CD_FLG, '30'::"VARCHAR" AS PDE_DAY_OF_SPPL_CATGY, COUNT(PDE_RECENT.PDE_CLAIM_NBR) AS PDE_CLAIM_NBR_CNT, SUM(PDE_RECENT.TOT_EST_MPF_COST) AS EST_MPF_COST_TOT, SUM(PDE_RECENT.TOT_EST_PDE_COST) AS EST_PDE_COST_TOT, SUM(PDE_RECENT.TOT_EST_DISCREPANCY) AS EST_DISCREPANCY_TOT, SUM(PDE_RECENT.PDE_DRG_QTY) AS PDE_DRUG_QTY_SUM, PDE_RECENT.SRC_ENV_SK, "TIMESTAMP"('now(0)'::"VARCHAR") AS INSERT_TS, "TIMESTAMP"('now(0)'::"VARCHAR") AS UPDATE_TS, 'APP_ORX_ETL_PRD'::"VARCHAR" AS INSERT_UID, 'APP_ORX_ETL_PRD'::"VARCHAR" AS UPDATE_UID, "NUMERIC"(TO_CHAR("TIMESTAMP"('now(0)'::"VARCHAR"), 'YYYYMMDDHH24MISS'::"VARCHAR"), 917516) AS RUN_ID, 1 AS REC_STAT_CD, PDE_RECENT.PDE_ADJ_DEL_CD FROM ((ADMIN.V_F_MPD_PDE_RECENT_MPF PDE_RECENT JOIN ORX_IDW_DM_PRD.ADMIN.D_CARRIER_CONTRACT_PBP_HIST CONTRACT_PBP_HIST ON ((((((CONTRACT_PBP_HIST.CONTRACT_ID = PDE_RECENT.PDE_CONTRACT_ID) AND (CONTRACT_PBP_HIST.PBP_ID = PDE_RECENT.PDE_PBP_ID)) AND (CONTRACT_PBP_HIST.BENEFIT_YR = SQLEXTDB.ADMIN."YEAR"(PDE_RECENT.PDE_FILLED_DT))) AND (CONTRACT_PBP_HIST.CARRIER_ID = PDE_RECENT.PDE_CARRIER_ID)) AND (CONTRACT_PBP_HIST.SRC_ENV_SK = PDE_RECENT.SRC_ENV_SK)))) LEFT JOIN (SELECT DIM.PDE_CONTRACT_ID, DIM.DIM_DIRECTORY_DT, DIM.UNIT_COST, DIM.RANK1, DIM.PDE_CLAIM_NBR FROM (SELECT RECENT.PDE_FILLED_DT, RECENT.PDE_CONTRACT_ID, RECENT.PROD_DIRECTORY_DT AS FF_DIRECTORY_DT, PF_FILE.PROD_DIRECTORY_DT AS DIM_DIRECTORY_DT, PF_FILE.UNIT_COST, PF_FILE.CMS_CONTRACT_ID, PF_FILE.DAYS_OF_SUPPLY, PF_FILE.CMS_PROXY_NDC_ID, PF_FILE.PRICE_ID, RECENT.PDE_CLAIM_NBR, DENSE_RANK() OVER (PARTITION BY PF_FILE.CMS_CONTRACT_ID, PF_FILE.DAYS_OF_SUPPLY, PF_FILE.CMS_PROXY_NDC_ID, PF_FILE.PRICE_ID  ORDER BY PF_FILE.PROD_DIRECTORY_DT ) AS RANK1 FROM (ADMIN.V_F_MPD_PDE_RECENT_MPF RECENT LEFT JOIN ORX_IDW_DM_PRD.ADMIN.D_CMS_DRUG_PRICING_FILE PF_FILE ON ((((((RECENT.PDE_CONTRACT_ID = PF_FILE.CMS_CONTRACT_ID) AND (RECENT.PDE_DAYS_OF_SUPPLY = PF_FILE.DAYS_OF_SUPPLY)) AND (RECENT.PRICE_ID = PF_FILE.PRICE_ID)) AND (RECENT.PDE_PROXY_PROD_ID = PF_FILE.CMS_PROXY_NDC_ID)) AND (RECENT.PRICING_FILE_MAIL_FLG = PF_FILE.PRICING_FILE_MAIL_FLG)))) WHERE (PF_FILE.PROD_DIRECTORY_DT >= RECENT.PROD_DIRECTORY_DT)) DIM WHERE (DIM.RANK1 = 4)) DD ON (((DD.PDE_CONTRACT_ID = PDE_RECENT.PDE_CONTRACT_ID) AND (DD.PDE_CLAIM_NBR = PDE_RECENT.PDE_CLAIM_NBR)))) WHERE (((((PDE_RECENT.PDE_DRG_CVG_CD = 'C'::BPCHAR) AND (CONTRACT_PBP_HIST.CPB_STATUS_CD = 'A'::BPCHAR)) AND (NOT ((PDE_RECENT.PDE_PROXY_PROD_ID = '-'::"VARCHAR") OR (PDE_RECENT.PRICE_ID = '-'::"VARCHAR") OR (PDE_RECENT.MPF_NDC_UNIT_COST = '0'::NUMERIC)))) AND (NOT (INT4((PDE_RECENT.PDE_COMPOUND_CD)::"VARCHAR") > 1))) AND (PDE_RECENT.PDE_DAYS_OF_SUPPLY = 30)) GROUP BY INT4(TO_CHAR("TIMESTAMP"(PDE_RECENT.PDE_FILLED_DT), 'YYYYMM'::"VARCHAR")), PDE_RECENT.CAG_SK, PDE_RECENT.PDE_CONTRACT_ID, PDE_RECENT.PDE_RECORD_ID, PDE_RECENT.PHR_RETAIL_FLG, PDE_RECENT.PDE_DRG_CVG_CD, CONTRACT_PBP_HIST.MEDICARE_PLAN_TYPE_CD, PDE_RECENT.PDE_CLAIM_STAT_ID, PDE_RECENT.PDE_PHR_SVC_TYP, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY > '-0.005'::NUMERIC(3,3)) AND (PDE_RECENT.TOT_EST_DISCREPANCY < '0.005'::NUMERIC(3,3))) THEN 'No Discrepancy'::"VARCHAR" WHEN ((CASE WHEN ((PDE_RECENT.PDE_DISPENSING_FEE - PDE_RECENT.MPF_DISPENSING_FEE) = '0'::NUMERIC) THEN NULL::"NUMERIC" ELSE (PDE_RECENT.PDE_DISPENSING_FEE - PDE_RECENT.MPF_DISPENSING_FEE) END / CASE WHEN (PDE_RECENT.TOT_EST_DISCREPANCY = '0'::NUMERIC) THEN NULL::"NUMERIC" ELSE PDE_RECENT.TOT_EST_DISCREPANCY END) > '0.5'::NUMERIC(1,1)) THEN 'Dispensing Fee'::"VARCHAR" WHEN (((PDE_RECENT.TOT_EST_DISCREPANCY >= '-0.01'::NUMERIC(2,2)) AND (PDE_RECENT.TOT_EST_DISCREPANCY <= '-0.005'::NUMERIC(3,3))) OR ((PDE_RECENT.TOT_EST_DISCREPANCY <= '0.01'::NUMERIC(2,2)) AND (PDE_RECENT.TOT_EST_DISCREPANCY >= '0.005'::NUMERIC(3,3)))) THEN 'Rounding Error'::"VARCHAR" WHEN (CASE WHEN (DD.RANK1 = 4) THEN DD.UNIT_COST ELSE '0'::NUMERIC END = '0'::NUMERIC) THEN 'Indeterminate'::"VARCHAR" WHEN ((ROUND(PDE_RECENT.MPF_NDC_UNIT_COST, 3) = ROUND(CASE WHEN (DD.RANK1 = 4) THEN DD.UNIT_COST ELSE '0'::NUMERIC END, 3)) AND (ROUND(PDE_RECENT.MPF_NDC_UNIT_COST, 3) <> ROUND(PDE_RECENT.PDE_NDC_UNIT_COST, 3))) THEN 'Proxy Issue'::"VARCHAR" WHEN ((ROUND(PDE_RECENT.MPF_NDC_UNIT_COST, 3) <> ROUND(CASE WHEN (DD.RANK1 = 4) THEN DD.UNIT_COST ELSE '0'::NUMERIC END, 3)) AND (ROUND(CASE WHEN (DD.RANK1 = 4) THEN DD.UNIT_COST ELSE '0'::NUMERIC END, 3) = ROUND(PDE_RECENT.PDE_NDC_UNIT_COST, 3))) THEN 'Timing Issue'::"VARCHAR" ELSE 'Other'::"VARCHAR" END, CASE WHEN (PDE_RECENT.TOT_EST_DISCREPANCY >= '0.005'::NUMERIC(3,3)) THEN 1 ELSE 0 END, CASE WHEN (PDE_RECENT.TOT_EST_DISCREPANCY <= '-0.005'::NUMERIC(3,3)) THEN 1 ELSE 0 END, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY > '-0.005'::NUMERIC(3,3)) AND (PDE_RECENT.TOT_EST_DISCREPANCY < '0.005'::NUMERIC(3,3))) THEN 1 ELSE 0 END, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY >= '-0.005'::NUMERIC(3,3)) AND (PDE_RECENT.TOT_EST_DISCREPANCY <= '0.005'::NUMERIC(3,3))) THEN 1 ELSE 0 END, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY >= '-0.01'::NUMERIC(2,2)) AND (PDE_RECENT.TOT_EST_DISCREPANCY <= '-0.005'::NUMERIC(3,3))) THEN 1 ELSE 0 END, CASE WHEN ((PDE_RECENT.TOT_EST_DISCREPANCY <= '0.01'::NUMERIC(2,2)) AND (PDE_RECENT.TOT_EST_DISCREPANCY >= '0.005'::NUMERIC(3,3))) THEN 1 ELSE 0 END, PDE_RECENT.PDE_BRAND_GENERIC_CD, PDE_RECENT.PHR_COST_TYPE, PDE_RECENT.PDE_PROD_ID, CASE WHEN (PDE_RECENT.PDE_PROD_ID = PDE_RECENT.PDE_PROXY_PROD_ID) THEN 1 ELSE 0 END, CASE WHEN (PDE_RECENT.PDE_PROD_ID <> PDE_RECENT.PDE_PROXY_PROD_ID) THEN 1 ELSE 0 END, CASE WHEN ((((((PDE_RECENT.PDE_PHR_SVC_TYP = '01'::"VARCHAR") OR (PDE_RECENT.PDE_PHR_SVC_TYP = '07'::"VARCHAR")) AND (PDE_RECENT.PHR_RETAIL_FLG = '1'::BPCHAR)) AND (PDE_RECENT.PHR_LTC_FLG = '0'::BPCHAR)) AND (PDE_RECENT.PHR_HI_FLG = '0'::BPCHAR)) AND (PDE_RECENT.PHR_MAIL_FLG = '0'::BPCHAR)) THEN 'B'::"VARCHAR" WHEN ((((PDE_RECENT.PHR_RETAIL_FLG = '1'::BPCHAR) AND (PDE_RECENT.PHR_LTC_FLG = '0'::BPCHAR)) AND (PDE_RECENT.PHR_HI_FLG = '0'::BPCHAR)) AND (PDE_RECENT.PHR_MAIL_FLG = '0'::BPCHAR)) THEN 'F'::"VARCHAR" WHEN ((PDE_RECENT.PDE_PHR_SVC_TYP = '01'::"VARCHAR") OR (PDE_RECENT.PDE_PHR_SVC_TYP = '07'::"VARCHAR")) THEN 'C'::"VARCHAR" ELSE 'N'::"VARCHAR" END, '30'::"VARCHAR", PDE_RECENT.SRC_ENV_SK, PDE_RECENT.PDE_AD
